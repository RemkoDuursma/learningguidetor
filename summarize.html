<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Data skills | A Learning Guide to R: data, analytical, and programming skills.</title>
  <meta name="description" content="This book teaches introductory to intermediate skills in R." />
  <meta name="generator" content="bookdown 0.11 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Data skills | A Learning Guide to R: data, analytical, and programming skills." />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book teaches introductory to intermediate skills in R." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Data skills | A Learning Guide to R: data, analytical, and programming skills." />
  
  <meta name="twitter:description" content="This book teaches introductory to intermediate skills in R." />
  

<meta name="author" content="Remko Duursma" />


<meta name="date" content="2019-06-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html">
<link rel="next" href="reporting.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css\style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Learning Guide to R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preface</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Beginner skills</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#installingr"><i class="fa fa-check"></i><b>2.1</b> Installing R and Rstudio</a><ul>
<li class="chapter" data-level="2.1.1" data-path="intro.html"><a href="intro.html#exampledata"><i class="fa fa-check"></i><b>2.1.1</b> Example data used throughout this book</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#basicops"><i class="fa fa-check"></i><b>2.2</b> Basic operations</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#vectorintro"><i class="fa fa-check"></i><b>2.3</b> Working with vectors</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#vectorized-operations"><i class="fa fa-check"></i><b>2.4</b> Vectorized operations</a><ul>
<li class="chapter" data-level="2.4.1" data-path="intro.html"><a href="intro.html#multifunctions"><i class="fa fa-check"></i><b>2.4.1</b> Applying multiple functions at once</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="intro.html"><a href="intro.html#objects-in-the-workspace"><i class="fa fa-check"></i><b>2.5</b> Objects in the workspace</a></li>
<li class="chapter" data-level="2.6" data-path="intro.html"><a href="intro.html#fileswd"><i class="fa fa-check"></i><b>2.6</b> Files in the working directory</a></li>
<li class="chapter" data-level="2.7" data-path="intro.html"><a href="intro.html#rstudio-projects"><i class="fa fa-check"></i><b>2.7</b> Rstudio projects</a></li>
<li class="chapter" data-level="2.8" data-path="intro.html"><a href="intro.html#packages"><i class="fa fa-check"></i><b>2.8</b> Packages</a><ul>
<li class="chapter" data-level="2.8.1" data-path="intro.html"><a href="intro.html#install-packages-from-cran"><i class="fa fa-check"></i><b>2.8.1</b> Install packages from CRAN</a></li>
<li class="chapter" data-level="2.8.2" data-path="intro.html"><a href="intro.html#setting-the-cran-mirror"><i class="fa fa-check"></i><b>2.8.2</b> Setting the CRAN mirror</a></li>
<li class="chapter" data-level="2.8.3" data-path="intro.html"><a href="intro.html#install-from-git-hosting-sites"><i class="fa fa-check"></i><b>2.8.3</b> Install from git hosting sites</a></li>
<li class="chapter" data-level="2.8.4" data-path="intro.html"><a href="intro.html#updating-r-and-package-locations"><i class="fa fa-check"></i><b>2.8.4</b> Updating R and package locations</a></li>
<li class="chapter" data-level="2.8.5" data-path="intro.html"><a href="intro.html#updatingpackages"><i class="fa fa-check"></i><b>2.8.5</b> Updating packages</a></li>
<li class="chapter" data-level="2.8.6" data-path="intro.html"><a href="intro.html#install-missing-packages"><i class="fa fa-check"></i><b>2.8.6</b> Install missing packages</a></li>
<li class="chapter" data-level="2.8.7" data-path="intro.html"><a href="intro.html#conflicts"><i class="fa fa-check"></i><b>2.8.7</b> Conflicts</a></li>
<li class="chapter" data-level="2.8.8" data-path="intro.html"><a href="intro.html#loading-many-packages"><i class="fa fa-check"></i><b>2.8.8</b> Loading many packages</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="intro.html"><a href="intro.html#helpfiles"><i class="fa fa-check"></i><b>2.9</b> Accessing the help files</a></li>
<li class="chapter" data-level="2.10" data-path="intro.html"><a href="intro.html#writing-lots-of-code-rmarkdown-or-scripts"><i class="fa fa-check"></i><b>2.10</b> Writing lots of code: rmarkdown or scripts?</a><ul>
<li class="chapter" data-level="2.10.1" data-path="intro.html"><a href="intro.html#reproducible-documents-with-rmarkdown"><i class="fa fa-check"></i><b>2.10.1</b> Reproducible documents with rmarkdown</a></li>
<li class="chapter" data-level="2.10.2" data-path="intro.html"><a href="intro.html#scripts"><i class="fa fa-check"></i><b>2.10.2</b> Using R scripts</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="summarize.html"><a href="summarize.html"><i class="fa fa-check"></i><b>3</b> Data skills</a><ul>
<li class="chapter" data-level="3.1" data-path="summarize.html"><a href="summarize.html#introduction"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="summarize.html"><a href="summarize.html#generating-data"><i class="fa fa-check"></i><b>3.2</b> Generating data</a><ul>
<li class="chapter" data-level="3.2.1" data-path="summarize.html"><a href="summarize.html#sequences"><i class="fa fa-check"></i><b>3.2.1</b> Sequences of numbers</a></li>
<li class="chapter" data-level="3.2.2" data-path="summarize.html"><a href="summarize.html#randomnumbers"><i class="fa fa-check"></i><b>3.2.2</b> Random numbers</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="summarize.html"><a href="summarize.html#readingdata"><i class="fa fa-check"></i><b>3.3</b> Reading data</a><ul>
<li class="chapter" data-level="3.3.1" data-path="summarize.html"><a href="summarize.html#readcsv"><i class="fa fa-check"></i><b>3.3.1</b> Reading CSV files</a></li>
<li class="chapter" data-level="3.3.2" data-path="summarize.html"><a href="summarize.html#reading-large-csv-files"><i class="fa fa-check"></i><b>3.3.2</b> Reading large CSV files</a></li>
<li class="chapter" data-level="3.3.3" data-path="summarize.html"><a href="summarize.html#tabdelimtext"><i class="fa fa-check"></i><b>3.3.3</b> Reading Tab-delimited text files</a></li>
<li class="chapter" data-level="3.3.4" data-path="summarize.html"><a href="summarize.html#including-data-in-a-script"><i class="fa fa-check"></i><b>3.3.4</b> Including data in a script</a></li>
<li class="chapter" data-level="3.3.5" data-path="summarize.html"><a href="summarize.html#json"><i class="fa fa-check"></i><b>3.3.5</b> JSON</a></li>
<li class="chapter" data-level="3.3.6" data-path="summarize.html"><a href="summarize.html#nosql-databases"><i class="fa fa-check"></i><b>3.3.6</b> (No)SQL databases</a></li>
<li class="chapter" data-level="3.3.7" data-path="summarize.html"><a href="summarize.html#excel-spreadsheets"><i class="fa fa-check"></i><b>3.3.7</b> Excel spreadsheets</a></li>
<li class="chapter" data-level="3.3.8" data-path="summarize.html"><a href="summarize.html#proprietary-formats"><i class="fa fa-check"></i><b>3.3.8</b> Proprietary formats</a></li>
<li class="chapter" data-level="3.3.9" data-path="summarize.html"><a href="summarize.html#web-services"><i class="fa fa-check"></i><b>3.3.9</b> Web services</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="summarize.html"><a href="summarize.html#dataframes"><i class="fa fa-check"></i><b>3.4</b> Working with dataframes</a><ul>
<li class="chapter" data-level="3.4.1" data-path="summarize.html"><a href="summarize.html#vecstodfr"><i class="fa fa-check"></i><b>3.4.1</b> Convert vectors into a dataframe</a></li>
<li class="chapter" data-level="3.4.2" data-path="summarize.html"><a href="summarize.html#variables-in-the-dataframe"><i class="fa fa-check"></i><b>3.4.2</b> Variables in the dataframe</a></li>
<li class="chapter" data-level="3.4.3" data-path="summarize.html"><a href="summarize.html#namesdataframe"><i class="fa fa-check"></i><b>3.4.3</b> Changing column names in dataframes</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="summarize.html"><a href="summarize.html#extracting-data"><i class="fa fa-check"></i><b>3.5</b> Extracting data</a><ul>
<li class="chapter" data-level="3.5.1" data-path="summarize.html"><a href="summarize.html#vectorindexing"><i class="fa fa-check"></i><b>3.5.1</b> Vectors</a></li>
<li class="chapter" data-level="3.5.2" data-path="summarize.html"><a href="summarize.html#subsetdataframes"><i class="fa fa-check"></i><b>3.5.2</b> Dataframes</a></li>
<li class="chapter" data-level="3.5.3" data-path="summarize.html"><a href="summarize.html#a-faster-method"><i class="fa fa-check"></i><b>3.5.3</b> A faster method</a></li>
<li class="chapter" data-level="3.5.4" data-path="summarize.html"><a href="summarize.html#deleting-columns"><i class="fa fa-check"></i><b>3.5.4</b> Deleting columns</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="summarize.html"><a href="summarize.html#exportingdata"><i class="fa fa-check"></i><b>3.6</b> Exporting data</a></li>
<li class="chapter" data-level="3.7" data-path="summarize.html"><a href="summarize.html#special-data-types"><i class="fa fa-check"></i><b>3.7</b> Special data types</a><ul>
<li class="chapter" data-level="3.7.1" data-path="summarize.html"><a href="summarize.html#workingfactors"><i class="fa fa-check"></i><b>3.7.1</b> Working with factors</a></li>
<li class="chapter" data-level="3.7.2" data-path="summarize.html"><a href="summarize.html#workinglogic"><i class="fa fa-check"></i><b>3.7.2</b> Working with logical data</a></li>
<li class="chapter" data-level="3.7.3" data-path="summarize.html"><a href="summarize.html#workingmissing"><i class="fa fa-check"></i><b>3.7.3</b> Working with missing values</a></li>
<li class="chapter" data-level="3.7.4" data-path="summarize.html"><a href="summarize.html#workingtext"><i class="fa fa-check"></i><b>3.7.4</b> Working with text</a></li>
<li class="chapter" data-level="3.7.5" data-path="summarize.html"><a href="summarize.html#workingwithdates"><i class="fa fa-check"></i><b>3.7.5</b> Working with dates and times</a></li>
<li class="chapter" data-level="3.7.6" data-path="summarize.html"><a href="summarize.html#converttype"><i class="fa fa-check"></i><b>3.7.6</b> Converting between data types</a></li>
</ul></li>
<li class="chapter" data-level="3.8" data-path="summarize.html"><a href="summarize.html#summarizing-dataframes"><i class="fa fa-check"></i><b>3.8</b> Summarizing dataframes</a><ul>
<li class="chapter" data-level="3.8.1" data-path="summarize.html"><a href="summarize.html#tapplyaggregate"><i class="fa fa-check"></i><b>3.8.1</b> Making summary tables</a></li>
<li class="chapter" data-level="3.8.2" data-path="summarize.html"><a href="summarize.html#xtabs"><i class="fa fa-check"></i><b>3.8.2</b> Tables of counts</a></li>
<li class="chapter" data-level="3.8.3" data-path="summarize.html"><a href="summarize.html#summaryvars"><i class="fa fa-check"></i><b>3.8.3</b> Adding summary variables to dataframes</a></li>
<li class="chapter" data-level="3.8.4" data-path="summarize.html"><a href="summarize.html#reorder"><i class="fa fa-check"></i><b>3.8.4</b> Reordering factor levels based on a summary variable</a></li>
</ul></li>
<li class="chapter" data-level="3.9" data-path="summarize.html"><a href="summarize.html#combining-dataframes"><i class="fa fa-check"></i><b>3.9</b> Combining dataframes</a><ul>
<li class="chapter" data-level="3.9.1" data-path="summarize.html"><a href="summarize.html#merge"><i class="fa fa-check"></i><b>3.9.1</b> Merging dataframes</a></li>
<li class="chapter" data-level="3.9.2" data-path="summarize.html"><a href="summarize.html#using-join-from-dplyr"><i class="fa fa-check"></i><b>3.9.2</b> Using join from <code>dplyr</code></a></li>
<li class="chapter" data-level="3.9.3" data-path="summarize.html"><a href="summarize.html#rbind"><i class="fa fa-check"></i><b>3.9.3</b> Row-binding dataframes</a></li>
</ul></li>
<li class="chapter" data-level="3.10" data-path="summarize.html"><a href="summarize.html#reshaping"><i class="fa fa-check"></i><b>3.10</b> Reshaping data</a><ul>
<li class="chapter" data-level="3.10.1" data-path="summarize.html"><a href="summarize.html#from-wide-to-long"><i class="fa fa-check"></i><b>3.10.1</b> From wide to long</a></li>
<li class="chapter" data-level="3.10.2" data-path="summarize.html"><a href="summarize.html#from-long-to-wide"><i class="fa fa-check"></i><b>3.10.2</b> From long to wide</a></li>
</ul></li>
<li class="chapter" data-level="3.11" data-path="summarize.html"><a href="summarize.html#more-complex-dplyr-examples"><i class="fa fa-check"></i><b>3.11</b> More complex <code>dplyr</code> examples</a><ul>
<li class="chapter" data-level="3.11.1" data-path="summarize.html"><a href="summarize.html#tree-growth-data-filter-and-multiple-groupings"><i class="fa fa-check"></i><b>3.11.1</b> Tree growth data: filter and multiple groupings</a></li>
<li class="chapter" data-level="3.11.2" data-path="summarize.html"><a href="summarize.html#crude-oil-production-find-top-exporters"><i class="fa fa-check"></i><b>3.11.2</b> Crude oil production: find top exporters</a></li>
<li class="chapter" data-level="3.11.3" data-path="summarize.html"><a href="summarize.html#weight-loss-data-make-an-irregular-timeseries-regular"><i class="fa fa-check"></i><b>3.11.3</b> Weight loss data: make an irregular timeseries regular</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="reporting.html"><a href="reporting.html"><i class="fa fa-check"></i><b>4</b> Visualizing data and making reports</a><ul>
<li class="chapter" data-level="4.1" data-path="reporting.html"><a href="reporting.html#introduction-1"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="reporting.html"><a href="reporting.html#visualizing"><i class="fa fa-check"></i><b>4.2</b> Visualizing data</a><ul>
<li class="chapter" data-level="4.2.1" data-path="reporting.html"><a href="reporting.html#base-graphics-or-ggplot2"><i class="fa fa-check"></i><b>4.2.1</b> Base graphics or <code>ggplot2</code>?</a></li>
<li class="chapter" data-level="4.2.2" data-path="reporting.html"><a href="reporting.html#base-graphics"><i class="fa fa-check"></i><b>4.2.2</b> Base graphics</a></li>
<li class="chapter" data-level="4.2.3" data-path="reporting.html"><a href="reporting.html#ggplot2"><i class="fa fa-check"></i><b>4.2.3</b> ggplot2</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="reporting.html"><a href="reporting.html#rmarkdown"><i class="fa fa-check"></i><b>4.3</b> Making reports</a><ul>
<li class="chapter" data-level="4.3.1" data-path="reporting.html"><a href="reporting.html#getting-started"><i class="fa fa-check"></i><b>4.3.1</b> Getting started</a></li>
<li class="chapter" data-level="4.3.2" data-path="reporting.html"><a href="reporting.html#tips"><i class="fa fa-check"></i><b>4.3.2</b> Tips</a></li>
<li class="chapter" data-level="4.3.3" data-path="reporting.html"><a href="reporting.html#rmarkdownresources"><i class="fa fa-check"></i><b>4.3.3</b> Resources</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="linmodel.html"><a href="linmodel.html"><i class="fa fa-check"></i><b>5</b> Basic statistics and linear modelling</a><ul>
<li class="chapter" data-level="5.1" data-path="linmodel.html"><a href="linmodel.html#introduction-2"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="linmodel.html"><a href="linmodel.html#distributions"><i class="fa fa-check"></i><b>5.2</b> Probability distributions</a></li>
<li class="chapter" data-level="5.3" data-path="linmodel.html"><a href="linmodel.html#descstat"><i class="fa fa-check"></i><b>5.3</b> Descriptive Statistics</a></li>
<li class="chapter" data-level="5.4" data-path="linmodel.html"><a href="linmodel.html#testing-differences-between-groups"><i class="fa fa-check"></i><b>5.4</b> Testing differences between groups</a><ul>
<li class="chapter" data-level="5.4.1" data-path="linmodel.html"><a href="linmodel.html#singlesample"><i class="fa fa-check"></i><b>5.4.1</b> Testing a single sample</a></li>
<li class="chapter" data-level="5.4.2" data-path="linmodel.html"><a href="linmodel.html#hypothesis-testing"><i class="fa fa-check"></i><b>5.4.2</b> Hypothesis testing</a></li>
<li class="chapter" data-level="5.4.3" data-path="linmodel.html"><a href="linmodel.html#inference-for-two-populations"><i class="fa fa-check"></i><b>5.4.3</b> Inference for two populations</a></li>
<li class="chapter" data-level="5.4.4" data-path="linmodel.html"><a href="linmodel.html#testing-many-groups-at-once-anova"><i class="fa fa-check"></i><b>5.4.4</b> Testing many groups at once (ANOVA)</a></li>
<li class="chapter" data-level="5.4.5" data-path="linmodel.html"><a href="linmodel.html#multcomp"><i class="fa fa-check"></i><b>5.4.5</b> Multiple comparisons</a></li>
<li class="chapter" data-level="5.4.6" data-path="linmodel.html"><a href="linmodel.html#twoway"><i class="fa fa-check"></i><b>5.4.6</b> Comparing many groups by two predictors (two-way ANOVA)</a></li>
<li class="chapter" data-level="5.4.7" data-path="linmodel.html"><a href="linmodel.html#interactions"><i class="fa fa-check"></i><b>5.4.7</b> Interactions</a></li>
<li class="chapter" data-level="5.4.8" data-path="linmodel.html"><a href="linmodel.html#comparing-models"><i class="fa fa-check"></i><b>5.4.8</b> Comparing models</a></li>
<li class="chapter" data-level="5.4.9" data-path="linmodel.html"><a href="linmodel.html#diagnostics"><i class="fa fa-check"></i><b>5.4.9</b> Diagnostics</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="linmodel.html"><a href="linmodel.html#linear-regression"><i class="fa fa-check"></i><b>5.5</b> Linear regression</a><ul>
<li class="chapter" data-level="5.5.1" data-path="linmodel.html"><a href="linmodel.html#icecream"><i class="fa fa-check"></i><b>5.5.1</b> Icecream sales: a motivating example</a></li>
<li class="chapter" data-level="5.5.2" data-path="linmodel.html"><a href="linmodel.html#simple-and-multiple-linear-regression"><i class="fa fa-check"></i><b>5.5.2</b> Simple and multiple linear regression</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="linmodel.html"><a href="linmodel.html#lmfaccont"><i class="fa fa-check"></i><b>5.6</b> Linear models with factors and continuous variables</a><ul>
<li class="chapter" data-level="5.6.1" data-path="linmodel.html"><a href="linmodel.html#predictedeffects"><i class="fa fa-check"></i><b>5.6.1</b> Visualizing fitted regression models</a></li>
<li class="chapter" data-level="5.6.2" data-path="linmodel.html"><a href="linmodel.html#icecreamtest"><i class="fa fa-check"></i><b>5.6.2</b> Group differences in regression models: back to ice cream sales</a></li>
<li class="chapter" data-level="5.6.3" data-path="linmodel.html"><a href="linmodel.html#logtransform"><i class="fa fa-check"></i><b>5.6.3</b> Logarithmic transformation</a></li>
<li class="chapter" data-level="5.6.4" data-path="linmodel.html"><a href="linmodel.html#quadlm"><i class="fa fa-check"></i><b>5.6.4</b> Adding quadratic and polynomial terms</a></li>
<li class="chapter" data-level="5.6.5" data-path="linmodel.html"><a href="linmodel.html#which-predictors-are-more-important"><i class="fa fa-check"></i><b>5.6.5</b> Which predictors are more important?</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="programming.html"><a href="programming.html"><i class="fa fa-check"></i><b>6</b> Functions, lists and loops</a><ul>
<li class="chapter" data-level="6.1" data-path="programming.html"><a href="programming.html#introduction-3"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="programming.html"><a href="programming.html#writefunctions"><i class="fa fa-check"></i><b>6.2</b> Writing simple functions</a><ul>
<li class="chapter" data-level="6.2.1" data-path="programming.html"><a href="programming.html#functions-with-many-arguments"><i class="fa fa-check"></i><b>6.2.1</b> Functions with many arguments</a></li>
<li class="chapter" data-level="6.2.2" data-path="programming.html"><a href="programming.html#functions-can-return-many-results"><i class="fa fa-check"></i><b>6.2.2</b> Functions can return many results</a></li>
<li class="chapter" data-level="6.2.3" data-path="programming.html"><a href="programming.html#functions-without-arguments"><i class="fa fa-check"></i><b>6.2.3</b> Functions without arguments</a></li>
<li class="chapter" data-level="6.2.4" data-path="programming.html"><a href="programming.html#wrapfunctions"><i class="fa fa-check"></i><b>6.2.4</b> Wrapper functions</a></li>
<li class="chapter" data-level="6.2.5" data-path="programming.html"><a href="programming.html#wrapper-functions-to-ggplot2-or-dplyr"><i class="fa fa-check"></i><b>6.2.5</b> Wrapper functions to <code>ggplot2</code> or <code>dplyr</code></a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="programming.html"><a href="programming.html#workinglists"><i class="fa fa-check"></i><b>6.3</b> Working with lists</a><ul>
<li class="chapter" data-level="6.3.1" data-path="programming.html"><a href="programming.html#indexing-lists"><i class="fa fa-check"></i><b>6.3.1</b> Indexing lists</a></li>
<li class="chapter" data-level="6.3.2" data-path="programming.html"><a href="programming.html#converting-lists-to-dataframes-or-vectors"><i class="fa fa-check"></i><b>6.3.2</b> Converting lists to dataframes or vectors</a></li>
<li class="chapter" data-level="6.3.3" data-path="programming.html"><a href="programming.html#combining-lists"><i class="fa fa-check"></i><b>6.3.3</b> Combining lists</a></li>
<li class="chapter" data-level="6.3.4" data-path="programming.html"><a href="programming.html#extracting-output-from-built-in-functions"><i class="fa fa-check"></i><b>6.3.4</b> Extracting output from built-in functions</a></li>
<li class="chapter" data-level="6.3.5" data-path="programming.html"><a href="programming.html#dfrlists"><i class="fa fa-check"></i><b>6.3.5</b> Creating lists from dataframes</a></li>
<li class="chapter" data-level="6.3.6" data-path="programming.html"><a href="programming.html#lapply"><i class="fa fa-check"></i><b>6.3.6</b> Applying functions to lists</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="programming.html"><a href="programming.html#simpleloops"><i class="fa fa-check"></i><b>6.4</b> Loops</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="webservices.html"><a href="webservices.html"><i class="fa fa-check"></i><b>7</b> R on the web</a><ul>
<li class="chapter" data-level="7.1" data-path="webservices.html"><a href="webservices.html#introduction-4"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="webservices.html"><a href="webservices.html#reading-data-from-remote-databases"><i class="fa fa-check"></i><b>7.2</b> Reading data from remote databases</a><ul>
<li class="chapter" data-level="7.2.1" data-path="webservices.html"><a href="webservices.html#nosql"><i class="fa fa-check"></i><b>7.2.1</b> NoSQL</a></li>
<li class="chapter" data-level="7.2.2" data-path="webservices.html"><a href="webservices.html#sql"><i class="fa fa-check"></i><b>7.2.2</b> SQL</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="webservices.html"><a href="webservices.html#accessing-an-api"><i class="fa fa-check"></i><b>7.3</b> Accessing an API</a></li>
<li class="chapter" data-level="7.4" data-path="webservices.html"><a href="webservices.html#deploying-an-api-with-plumber"><i class="fa fa-check"></i><b>7.4</b> Deploying an API with <code>plumber</code></a><ul>
<li class="chapter" data-level="7.4.1" data-path="webservices.html"><a href="webservices.html#deploying-a-simple-api"><i class="fa fa-check"></i><b>7.4.1</b> Deploying a simple API</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">A Learning Guide to R: data, analytical, and programming skills.</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="summarize" class="section level1">
<h1><span class="header-section-number">Chapter 3</span> Data skills</h1>
<div id="introduction" class="section level2">
<h2><span class="header-section-number">3.1</span> Introduction</h2>
<p>Analysing data is much more than applying the right statistics at the right time. A lot of effort and time is spent on reading, filtering, reshaping, bending and twisting your data before you can actually use the data for visualization and analysis.</p>
<p>In this chapter we learn many skills for working with data in R. All of these skills can be seen as mandatory skills before you learn new statistical techniques or fancy new visualizations. We first look at reading datasets into <em>dataframes</em>, filtering data when certain conditions are met, and learn in detail about the most important data types that can be stored in dataframes.</p>
<p>We will also look at various ways to summarize data, from simple summaries of what is contained in the original data, to more complex tables of statistics by grouping variables. Finally we will look at merging (joining) dataframes by one or more key-variables, and reshaping datasets (from long to wide, and back).</p>
<p><strong>Packages used in this chapter</strong></p>
<p>The examples will generally let you know which packages are used, but for your convenience, here is a complete list of the packages used.</p>
<p>For plotting, we often use <code>ggplot2</code> and <code>ggthemes</code> (these are usually omitted from the examples):</p>
<p>Otherwise:</p>
<ul>
<li><code>lgrdata</code> (for the example datasets, see <a href="intro.html#exampledata">2.1.1</a>)</li>
<li><code>lubridate</code> (for dates and times)</li>
<li><code>dplyr</code> (for various data skills)</li>
<li><code>padr</code> (for aggregating timeseries data)</li>
<li><code>doBy</code> (for <code>summaryBy</code>, handy for making summary tables)</li>
<li><code>Hmisc</code> (for <code>contents</code> and <code>describe</code>, both summarize dataframes)</li>
<li><code>tidyr</code> (for reshaping dataframes)</li>
<li><code>reshape2</code> (for reshaping dataframes)</li>
<li><code>data.table</code> (for <code>fread</code>, fast reading of dataframes)</li>
<li><code>readxl</code> (for reading Excel files)</li>
<li><code>stringr</code> (for working with text)</li>
</ul>
</div>
<div id="generating-data" class="section level2">
<h2><span class="header-section-number">3.2</span> Generating data</h2>
<div id="sequences" class="section level3">
<h3><span class="header-section-number">3.2.1</span> Sequences of numbers</h3>
<p>Let’s look at a few ways to generate sequences of numbers that we can use in the examples and exercises. There are also a number of real-world situations where you want to use these functions.</p>
<p>First, as we saw already, we can use <code>c</code>() to ‘concatenate’ (link together) a series of numbers. We can also combine existing vectors in this way, for example:</p>
<pre class="sourceCode r"><code class="sourceCode r">a &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)
b &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>)
<span class="kw">c</span>(a,b)</code></pre>
<pre><code>## [1] 1 2 3 4 5 6</code></pre>
<p>We can generate sequences of numbers using <code>:</code>, <code>seq</code> and <code>rep</code>, like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Sequences of integer numbers using the &quot;:&quot; operator:</span>
<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>   <span class="co"># Numbers 1 through 10</span></code></pre>
<pre><code>##  [1]  1  2  3  4  5  6  7  8  9 10</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="dv">5</span><span class="op">:-</span><span class="dv">5</span>   <span class="co"># From 5 to -5, backwards</span></code></pre>
<pre><code>##  [1]  5  4  3  2  1  0 -1 -2 -3 -4 -5</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Examples using seq()</span>
<span class="kw">seq</span>(<span class="dt">from=</span><span class="dv">10</span>,<span class="dt">to=</span><span class="dv">100</span>,<span class="dt">by=</span><span class="dv">10</span>)</code></pre>
<pre><code>##  [1]  10  20  30  40  50  60  70  80  90 100</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">seq</span>(<span class="dt">from=</span><span class="dv">23</span>, <span class="dt">by=</span><span class="dv">2</span>, <span class="dt">length=</span><span class="dv">12</span>)</code></pre>
<pre><code>##  [1] 23 25 27 29 31 33 35 37 39 41 43 45</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Replicate numbers:</span>
<span class="kw">rep</span>(<span class="dv">2</span>, <span class="dt">times =</span> <span class="dv">10</span>)</code></pre>
<pre><code>##  [1] 2 2 2 2 2 2 2 2 2 2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">5</span>), <span class="dt">each=</span><span class="dv">3</span>)</code></pre>
<pre><code>## [1] 4 4 4 5 5 5</code></pre>
<p>The <code>rep</code> function works with any type of vector. For example, character vectors:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Simple replication</span>
<span class="kw">rep</span>(<span class="st">&quot;a&quot;</span>, <span class="dt">times =</span> <span class="dv">3</span>)</code></pre>
<pre><code>## [1] &quot;a&quot; &quot;a&quot; &quot;a&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Repeat elements of a vector</span>
<span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;E. tereticornis&quot;</span>,<span class="st">&quot;E. saligna&quot;</span>), <span class="dt">each=</span><span class="dv">3</span>)</code></pre>
<pre><code>## [1] &quot;E. tereticornis&quot; &quot;E. tereticornis&quot; &quot;E. tereticornis&quot; &quot;E. saligna&quot;     
## [5] &quot;E. saligna&quot;      &quot;E. saligna&quot;</code></pre>
</div>
<div id="randomnumbers" class="section level3">
<h3><span class="header-section-number">3.2.2</span> Random numbers</h3>
<p>We can draw random numbers using the <code>runif</code> function. The <code>runif</code> function draws from a uniform distribution, meaning there is an equal probability of any number being chosen.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Ten random numbers between 0 and 1</span>
<span class="kw">runif</span>(<span class="dv">10</span>)</code></pre>
<pre><code>##  [1] 0.8048764 0.1155593 0.6591333 0.7554428 0.6925971 0.9671985 0.5053061
##  [8] 0.9216269 0.5886584 0.9994918</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Five random numbers between 100 and 1000</span>
<span class="kw">runif</span>(<span class="dv">5</span>, <span class="dv">100</span>, <span class="dv">1000</span>)</code></pre>
<pre><code>## [1] 555.1091 583.5694 714.5387 897.6285 752.8683</code></pre>

<div class="rmdtry">
The <code>runif</code> function is part of a much larger class of functions, each of which returns
numbers from a different probability distribution. Inspect the help pages of the functions <code>rnorm</code>
for the normal distribution, and <code>rexp</code> for the exponential distribution. Try generating some data from a normal distribution with a mean of 100, and a standard deviation of 10.
</div>

<p>Next, we will <code>sample</code> numbers from an existing vector.</p>
<pre class="sourceCode r"><code class="sourceCode r">numbers &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">15</span>
<span class="kw">sample</span>(numbers, <span class="dt">size=</span><span class="dv">20</span>, <span class="dt">replace=</span><span class="ot">TRUE</span>)</code></pre>
<pre><code>##  [1]  5 14  6 10  9  5 12  9  6 15  4 14 12 12 14 15 10 11  1 10</code></pre>
<p>This command samples 20 numbers from the <code>numbers</code> vector, with replacement.</p>
</div>
</div>
<div id="readingdata" class="section level2">
<h2><span class="header-section-number">3.3</span> Reading data</h2>
<p>There are many ways to read data into R, but we are going to keep things simple and show only a couple of options to read data from text files, and from databases (hosted online).</p>
<p>Throughout this book we focus on ‘rectangular data’, that is, data that can be organized in a table with columns and rows. A data table like this, with individual observations in rows, and various data fields in columns, is called a <em>data frame</em>.</p>
<p>We first show a few options to read text files into dataframes in R, including comma, tab-delimited, and JSON formats, and how to read data from Excel. Reading data from remote (No)SQL databases is included in Chapter <a href="webservices.html#webservices">7</a>.</p>
<div id="readcsv" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Reading CSV files</h3>
<p>A very common text format for data is ‘Comma-Separated Values’, or CSV. You can use <code>read.csv</code> to read these files. Suppose you have the file <code>Allometry.csv</code> in your working directory, you can read in the file into a dataframe with,</p>
<pre class="sourceCode r"><code class="sourceCode r">allometry &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;Allometry.csv&quot;</span>)</code></pre>
<p>Here, <code>read.csv</code> assumes that your system uses a point (‘.’) to separate digits, but in many parts of the world the default is a comma - in which case values are separated by ‘;’. In this case, use <code>read.csv2</code> instead of <code>read.csv</code>.</p>
<p>Make sure you fully understand the concept of a working directory (see Section <a href="intro.html#fileswd">2.6</a>) before continuing.</p>
<p>If the file is stored elsewhere, you can specify the entire path (this is known as an <em>absolute</em> path).</p>
<pre class="sourceCode r"><code class="sourceCode r">allometry &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;c:/projects/data/Allometry.csv&quot;</span>)</code></pre>
<p>It is generally <em>not recommended</em> to use absolute paths, because the script will then depend on an exact location of a datafile. But sometimes you want to refer to very large files or databases that are stored in a central location.</p>
<p>If the file is stored in a sub-directory of your working directory, you can specify the <em>relative</em> path.</p>
<pre class="sourceCode r"><code class="sourceCode r">allometry &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/Allometry.csv&quot;</span>)</code></pre>
<p>The latter option is probably useful to keep your data files separate from your scripts and outputs in your working directory.</p>
<!--We will not discuss how to organize your files here, but return to this important topic in Chapter \@ref(projectman).-->
<p>The function <code>read.csv</code> has many options, let’s look at some of them. We can skip a number of rows from being read, and only read a fixed number of rows. For example, use this command to read rows 10-15, skipping the header line (which is in the first line of the file) and the next 9 lines.  you have to skip 10 rows to read rows 10-15, because the header line (which is ignored) counts as a row in the text file!</p>
<pre class="sourceCode r"><code class="sourceCode r">allomsmall &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;Allometry.csv&quot;</span>, <span class="dt">skip=</span><span class="dv">10</span>, <span class="dt">nrows=</span><span class="dv">5</span>, <span class="dt">header=</span><span class="ot">FALSE</span>)</code></pre>
</div>
<div id="reading-large-csv-files" class="section level3">
<h3><span class="header-section-number">3.3.2</span> Reading large CSV files</h3>
<p>We used the built-in <code>read.csv</code> function above, but note that for large files, it is rather slow. The best alternative is to use <code>fread</code> from the <code>data.table</code> package. The <code>data.table</code> package is an excellent resource if you need to do data manipulations on large files (though the syntax takes some getting used to).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)
allom &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;Allometry.csv&quot;</span>)</code></pre>
<p>Of course, you could use <code>fread</code> even for small files, but I generally recommend to keep dependencies to a minimum. In other words, use built-in (‘base’) functions when you can, to develop more robust and reproducable code.</p>
</div>
<div id="tabdelimtext" class="section level3">
<h3><span class="header-section-number">3.3.3</span> Reading Tab-delimited text files</h3>
<p>Sometimes, data files are provided as text files that are TAB-delimited. To read these files, use the following command:</p>
<pre class="sourceCode r"><code class="sourceCode r">mydata &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;sometabdelimdata.txt&quot;</span>, <span class="dt">header=</span><span class="ot">TRUE</span>)</code></pre>
<p>In fact, <code>read.table</code> is the more general function - <code>read.csv</code> is a specific case for comma-delimited files. When using <code>read.table</code>, you must specify whether a header (i.e., a row with column names) is present in the dataset (unlike <code>read.csv</code>, it is the default to not read the header). If you have a text file with some other delimiter, for example <code>;</code>, use the <code>sep</code> argument:</p>
<pre class="sourceCode r"><code class="sourceCode r">mydata &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;somedelimdata.txt&quot;</span>, <span class="dt">header=</span><span class="ot">TRUE</span>, <span class="dt">sep=</span><span class="st">&quot;;&quot;</span>)</code></pre>
</div>
<div id="including-data-in-a-script" class="section level3">
<h3><span class="header-section-number">3.3.4</span> Including data in a script</h3>
<p>You can also write the dataset in a text file, and read it as in the following examples. This is useful if you have (found) a small dataset that you typed in by hand, or for making reproducible code snippets that include the dataset.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">read.table</span>(<span class="dt">header=</span><span class="ot">TRUE</span>, <span class="dt">text=</span><span class="st">&quot;</span>
<span class="st">a b</span>
<span class="st">1 2</span>
<span class="st">3 4</span>
<span class="st">&quot;</span>)</code></pre>
<pre><code>##   a b
## 1 1 2
## 2 3 4</code></pre>
</div>
<div id="json" class="section level3">
<h3><span class="header-section-number">3.3.5</span> JSON</h3>
<p>A very popular format for data, especially on the web, is JSON - a text-based format that can represent not just rectangular data (dataframes), but any complex nested data structure.</p>
<p>We can use the <code>jsonlite</code> package to read JSON data, and convert it to a dataframe if the data allows it, as in the following example.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fake data can be read fro this site.</span>
<span class="co"># Visit the link to see what the original data looks like.</span>
url &lt;-<span class="st"> &quot;https://jsonplaceholder.typicode.com/posts/1/comments&quot;</span>

<span class="co"># Package to read JSON; it is very fast.</span>
<span class="kw">library</span>(jsonlite)

<span class="co"># fromJSON reads and simplifies the data into a dataframe (if possible)</span>
comment_data &lt;-<span class="st"> </span><span class="kw">fromJSON</span>(url)

<span class="co"># We end up with a dataframe.</span>
Hmisc<span class="op">::</span><span class="kw">contents</span>(comment_data)</code></pre>
<pre><code>## 
## Data frame:comment_data  500 observations and 5 variables    Maximum # NAs:0
## 
## 
##          Storage
## postId   integer
## id       integer
## name   character
## email  character
## body   character</code></pre>
</div>
<div id="nosql-databases" class="section level3">
<h3><span class="header-section-number">3.3.6</span> (No)SQL databases</h3>
<p>We show examples of how to obtain data from SQL and NoSQL databases in Chapter <a href="webservices.html#webservices">7</a>.</p>
</div>
<div id="excel-spreadsheets" class="section level3">
<h3><span class="header-section-number">3.3.7</span> Excel spreadsheets</h3>
<p>Excel spreadsheets are <em>not</em> a recommended way to store data, but often you don’t make that choice yourself. If you do need to read an XLS or XLSX file, the <code>readxl</code> package works very well. <em>Note</em>: avoid older implementations like the <code>xlsx</code> package and <code>read.xls</code> in the <code>gtools</code> package, which are less reliable.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(readxl)
mydata &lt;-<span class="st"> </span><span class="kw">read_excel</span>(<span class="st">&quot;mspreadsheet.xlsx&quot;</span>, <span class="dt">sheet =</span> <span class="dv">2</span>)</code></pre>
<p>Here, <code>sheet</code> will specify the sheet by number, alternatively you can refer to the sheet by name (e.g., <code>sheet = 'rawdata'</code>).</p>
</div>
<div id="proprietary-formats" class="section level3">
<h3><span class="header-section-number">3.3.8</span> Proprietary formats</h3>
<p>Many statistical software packages store data in their own format, not just text files. For data from <strong>SPSS</strong>, <strong>SAS</strong> or <strong>Stata</strong>, we recommend the <code>haven</code> package for reading the data into dataframes, and the <code>foreign</code> package provides further support for Minitab, <strong>Systat</strong>, and <strong>Weka.</strong></p>
</div>
<div id="web-services" class="section level3">
<h3><span class="header-section-number">3.3.9</span> Web services</h3>
<p>Nowadays many data are available via a ‘RESTful’ API, which is now by far the most common way to download publicly available (open) data (and many other services as well). We discuss reading data from a REST service, as well as setting up our REST service in Chapter <a href="webservices.html#webservices">7</a>.</p>
</div>
</div>
<div id="dataframes" class="section level2">
<h2><span class="header-section-number">3.4</span> Working with dataframes</h2>
<p>As mentioned, this book focuses heavily on dataframes, because this is the object you will use most of the time in data analysis. The following sections provide a brief introduction, but we will see many examples using dataframes throughout this manual.</p>
<p>Like matrices, dataframes have two dimensions: they contain both columns and rows. Unlike matrices, each column can hold a different type of data. This is very useful for keeping track of different types of information about data points. For example, you might use one column to hold height measurements, and another to hold the matching species IDs. When you read in a file using <code>read.csv</code>, the data is automatically stored in a dataframe. Dataframes can also be created from scratch using the function <code>data.frame</code> (see Section <a href="summarize.html#vecstodfr">3.4.1</a>), but usually we start with data read from a file.</p>

<div class="rmdinfo">
<strong>What is a tibble?</strong>
Sometimes you will notice that some functions return objects that are very similar to
dataframes, but are actually called ‘tibbles’ (for example, <code>read_excel</code> returns one). A tibble is a newer format for dataframes, and is internally very nearly the same. You can pretty much always assume that dataframes and tibbles behave in the same way.
</div>

<div id="vecstodfr" class="section level3">
<h3><span class="header-section-number">3.4.1</span> Convert vectors into a dataframe</h3>
<p>Suppose you have two or more vectors (of the same length), and you want to include these in a new dataframe. You can use the function <code>data.frame</code>. Here is a simple example:</p>
<pre class="sourceCode r"><code class="sourceCode r">vec1 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">9</span>,<span class="dv">10</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">45</span>)
vec2 &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">5</span>

<span class="kw">data.frame</span>(<span class="dt">x =</span> vec1, <span class="dt">y =</span> vec2)</code></pre>
<pre><code>##    x y
## 1  9 1
## 2 10 2
## 3  1 3
## 4  2 4
## 5 45 5</code></pre>
<p>Here, we made a dataframe with columns named <code>x</code> and <code>y</code>. <em>Note</em>: take care to ensure that the vectors have the same length, otherwise it won’t work!</p>

<div class="rmdtry">
Modify the previous example so that the two vectors are <em>not</em> the same length. Then, attempt to combine them in a dataframe and inspect the resulting error message.
</div>

</div>
<div id="variables-in-the-dataframe" class="section level3">
<h3><span class="header-section-number">3.4.2</span> Variables in the dataframe</h3>
<p>We read the <code>allometry</code> data (make sure the <code>lgrdata</code> package is loaded) to practice basic dataframe skills.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lgrdata)
<span class="kw">data</span>(allometry)</code></pre>
<p>After reading the dataframe, it is good practice to always quickly inspect the dataframe to see if anything went wrong. I routinely look at the first few rows with <code>head</code>. Then, to check the types of variables in the dataframe, use the <code>str</code> function (short for ‘structure’). This function is useful for other objects as well, to view in detail what the object contains.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(allometry)</code></pre>
<pre><code>##   species diameter height   leafarea branchmass
## 1    PSME    54.61  27.04 338.485622  410.24638
## 2    PSME    34.80  27.42 122.157864   83.65030
## 3    PSME    24.89  21.23   3.958274    3.51270
## 4    PSME    28.70  24.96  86.350653   73.13027
## 5    PSME    34.80  29.99  63.350906   62.39044
## 6    PSME    37.85  28.07  61.372765   53.86594</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(allometry)</code></pre>
<pre><code>## &#39;data.frame&#39;:    63 obs. of  5 variables:
##  $ species   : Factor w/ 3 levels &quot;PIMO&quot;,&quot;PIPO&quot;,..: 3 3 3 3 3 3 3 3 3 3 ...
##  $ diameter  : num  54.6 34.8 24.9 28.7 34.8 ...
##  $ height    : num  27 27.4 21.2 25 30 ...
##  $ leafarea  : num  338.49 122.16 3.96 86.35 63.35 ...
##  $ branchmass: num  410.25 83.65 3.51 73.13 62.39 ...</code></pre>
<p>Individual variables in a dataframe can be extracted using the dollar <code>$</code> sign.
Let’s print all the tree diameters here, after rounding to one decimal point:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">round</span>(allometry<span class="op">$</span>diameter,<span class="dv">1</span>)</code></pre>
<pre><code>##  [1] 54.6 34.8 24.9 28.7 34.8 37.9 22.6 39.4 39.9 26.2 43.7 69.8 44.5 56.6
## [15] 54.6  5.3  6.1  7.4  8.3 13.5 51.3 22.4 69.6 58.4 33.3 44.2 30.5 27.4
## [29] 43.2 38.9 52.6 20.8 24.1 24.9 46.0 35.0 23.9 60.2 12.4  4.8 70.6 11.4
## [43] 11.9 60.2 60.7 70.6 57.7 43.1 18.3 43.4 18.5 12.9 37.9 26.9 38.6  6.5
## [57] 31.8 73.7 28.2 61.5 51.6 18.3  8.4</code></pre>
<p>It is also straightforward to add new variables to a dataframe. Let’s convert the tree diameter to inches, and add it to the dataframe as a new variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">allometry<span class="op">$</span>diameterInch &lt;-<span class="st"> </span>allometry<span class="op">$</span>diameter <span class="op">/</span><span class="st"> </span><span class="fl">2.54</span></code></pre>
<p>Instead of using the <code>$</code>-notation every time (which can result in lengthy, messy code, especially when your variable names are long) you can use <code>with</code> to indicate where the variables are stored. Let’s add a new variable called <code>volindex</code>, a volume index defined as the square of tree diameter times height:</p>
<pre class="sourceCode r"><code class="sourceCode r">allometry<span class="op">$</span>volindex &lt;-<span class="st"> </span><span class="kw">with</span>(allometry, diameter<span class="op">^</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>height)</code></pre>
<p>The <code>with</code> function allows for more readable code, while at the same time making sure that the variables <code>diameter</code> and <code>height</code> are read from the dataframe <code>allometry</code>.</p>
<p>An even better approach is to use <code>mutate</code> from the <code>dplyr</code> package (similar to base R’s <code>transform</code>, but with a useful advantage).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
allometry &lt;-<span class="st"> </span><span class="kw">mutate</span>(allometry, 
                <span class="dt">diameterInch =</span> diameter <span class="op">/</span><span class="st"> </span><span class="fl">2.54</span>,
                <span class="dt">volindex =</span> diameterInch<span class="op">^</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>height)</code></pre>
<p>Where <code>mutate</code> adds new variables to the dataframe, and (unlike <code>transform</code>) it is able to use variables used just before in the same call (note <code>diameterInch</code> was created in the same call).</p>

<div class="rmdtry">
The above examples are important - many times throughout this book you will be required to perform similar operations. As an exercise, also add the ratio of height to diameter to the dataframe.
</div>

<p>A simple summary of the dataframe can be printed with the <code>summary</code> function; where we use indexing (<code>[,1:3]</code>) to use the first three columns of <code>allometry</code> only to save space.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(allometry[,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>])</code></pre>
<pre><code>##  species      diameter         height     
##  PIMO:19   Min.   : 4.83   Min.   : 3.57  
##  PIPO:22   1st Qu.:21.59   1st Qu.:21.26  
##  PSME:22   Median :34.80   Median :28.40  
##            Mean   :35.56   Mean   :26.01  
##            3rd Qu.:51.44   3rd Qu.:33.93  
##            Max.   :73.66   Max.   :44.99</code></pre>
<p>For the numeric variables, the minimum, 1st quantile, median, mean, 3rd quantile, and maximum values are printed. For so-called ‘factor’ variables (i.e., categorical variables), a simple table is printed (in this case, for the <code>species</code> variable). We will come back to factors in Section sec:workingfactors. If the variables have missing values, the number of missing values is printed as well (see Section <a href="summarize.html#workingmissing">3.7.3</a>).</p>
<!--If you are using an `rmarkdown` document - see Section \@ref(XXX) on how to make R output pretty when the document is converted to HTML.
-->
<p>To see how many rows and columns your dataframe contains (handy for double-checking you read the data correctly), use <code>nrow</code> and <code>ncol</code>. Alternatively, <code>dim</code> gives the ‘dimension’ of the dataframe (rows x columns).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(allometry)</code></pre>
<pre><code>## [1] 63</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ncol</span>(allometry)</code></pre>
<pre><code>## [1] 7</code></pre>
</div>
<div id="namesdataframe" class="section level3">
<h3><span class="header-section-number">3.4.3</span> Changing column names in dataframes</h3>
<p>To access the names of a dataframe as a vector, use the <code>names</code> function. You can also use this to change the names. Consider this example:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># read names:</span>
<span class="kw">names</span>(allometry)</code></pre>
<pre><code>## [1] &quot;species&quot;      &quot;diameter&quot;     &quot;height&quot;       &quot;leafarea&quot;    
## [5] &quot;branchmass&quot;   &quot;diameterInch&quot; &quot;volindex&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># rename all (make sure vector is same length as number of columns!)</span>
<span class="kw">names</span>(allometry) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;spec&quot;</span>,<span class="st">&quot;diam&quot;</span>,<span class="st">&quot;ht&quot;</span>,<span class="st">&quot;leafarea&quot;</span>,<span class="st">&quot;branchm&quot;</span>)</code></pre>
<p>We can also change some of the names, using simple indexing (see Section <a href="summarize.html#vectorindexing">3.5.1</a>).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># rename Second one to &#39;Diam&#39;</span>
<span class="kw">names</span>(allometry)[<span class="dv">2</span>] &lt;-<span class="st"> &quot;Diam&quot;</span>

<span class="co"># rename 1st and 2nd:</span>
<span class="kw">names</span>(allometry)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SP&quot;</span>,<span class="st">&quot;D&quot;</span>)</code></pre>
<p>Better yet is to use <code>rename</code> from the <code>dplyr</code> package, which makes sure you change the right column names (indexing as above can be dangerous if the order of columns has changed!).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)

<span class="co"># The names on the right are the original names, on the left are the new ones.</span>
allometry &lt;-<span class="st"> </span><span class="kw">rename</span>(allometry, 
                       <span class="dt">spec =</span> species,
                       <span class="dt">diam =</span> diameter)</code></pre>
</div>
</div>
<div id="extracting-data" class="section level2">
<h2><span class="header-section-number">3.5</span> Extracting data</h2>
<div id="vectorindexing" class="section level3">
<h3><span class="header-section-number">3.5.1</span> Vectors</h3>
<p>Let’s look at reordering or taking subsets of a vector, or <code>indexing</code> as it is commonly called. This is an important skill to learn, so we will look at several examples.</p>
<p>Let’s define two <code>numeric vectors</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">nums1 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">2</span>,<span class="dv">8</span>,<span class="dv">11</span>,<span class="dv">100</span>,<span class="dv">8</span>)
nums2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">3.3</span>,<span class="fl">8.1</span>,<span class="fl">2.5</span>,<span class="fl">9.8</span>,<span class="fl">21.2</span>,<span class="fl">13.8</span>,<span class="fl">0.9</span>)</code></pre>
<p>Individual elements of a vector can be extracted using square brackets, <code>[ ]</code>. For example, to extract the first and then the fifth element of a vector:</p>
<pre class="sourceCode r"><code class="sourceCode r">nums1[<span class="dv">1</span>]</code></pre>
<pre><code>## [1] 1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">nums1[<span class="dv">5</span>]</code></pre>
<pre><code>## [1] 11</code></pre>
<p>You can also use another object to do the indexing, as long as it contains a integer number. For example,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Get last element:</span>
nelements &lt;-<span class="st"> </span><span class="kw">length</span>(nums1)
nums1[nelements]</code></pre>
<pre><code>## [1] 8</code></pre>
<p>This last example extracts the last element of a vector. To do this, we first found the length of the vector, and used that to <em>index</em> the vector to extract the last element.</p>
<p>We can also select multiple elements, by <em>indexing</em> the vector with another vector. Recall how to construct sequences of numbers, explained in Section <a href="summarize.html#sequences">3.2.1</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select the first 3:</span>
nums1[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</code></pre>
<pre><code>## [1] 1 4 2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select a few elements of a vector:</span>
selectthese &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">2</span>)
nums1[selectthese]</code></pre>
<pre><code>## [1]  1 11  4</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select every other element:</span>
everyother &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">1</span>,<span class="dv">7</span>,<span class="dt">by=</span><span class="dv">2</span>)
nums1[everyother]</code></pre>
<pre><code>## [1]  1  2 11  8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select five random elements:</span>
ranels &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(nums2), <span class="dv">5</span>)
nums2[ranels]</code></pre>
<pre><code>## [1] 21.2  8.1  0.9  2.5  9.8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Remove the first element:</span>
nums1[<span class="op">-</span><span class="dv">1</span>]</code></pre>
<pre><code>## [1]   4   2   8  11 100   8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Remove the first and last element:</span>
nums1[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">length</span>(nums1))]</code></pre>
<pre><code>## [1]   4   2   8  11 100</code></pre>
<p>Next, we can look at selecting elements of a vector based on the values in that vector. Suppose we want to make a new vector, based on vector <code>nums2</code> but only where the value within certain bounds. We can use simple logical statements to index a vector.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Subset of nums2, where value is at least 10 :</span>
nums2[nums2 <span class="op">&gt;</span><span class="st"> </span><span class="dv">10</span>]</code></pre>
<pre><code>## [1] 21.2 13.8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Subset of nums2, where value is between 5 and 10:</span>
nums2[nums2 <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span> <span class="op">&amp;</span><span class="st"> </span>nums2 <span class="op">&lt;</span><span class="st"> </span><span class="dv">10</span>]</code></pre>
<pre><code>## [1] 8.1 9.8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Subset of nums2, where value is smaller than 1, or larger than 20:</span>
nums2[nums2 <span class="op">&lt;</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>nums2 <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>]</code></pre>
<pre><code>## [1] 21.2  0.9</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Subset of nums1, where value is exactly 8:</span>
nums1[nums1 <span class="op">==</span><span class="st"> </span><span class="dv">8</span>]</code></pre>
<pre><code>## [1] 8 8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Subset nums1 where number is NOT equal to 100</span>
nums1[nums1 <span class="op">!=</span><span class="st"> </span><span class="dv">100</span>]</code></pre>
<pre><code>## [1]  1  4  2  8 11  8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Subset of nums1, where value is one of 1,4 or 11:</span>
nums1[nums1 <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">11</span>)]</code></pre>
<pre><code>## [1]  1  4 11</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Subset of nums1, where value is NOT 1,4 or 11:</span>
nums1[<span class="op">!</span>(nums1 <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">11</span>))]</code></pre>
<pre><code>## [1]   2   8 100   8</code></pre>
<p>These examples showed you several new logical operators (&lt;, &gt;, ==, &amp;). See the help page <code>?Logic</code> for more details on logical operators. We will return to logical data in Section sec:workinglogic.</p>
<div id="assigning-new-values-to-subsets" class="section level4">
<h4><span class="header-section-number">3.5.1.1</span> Assigning new values to subsets</h4>
<p>All of this becomes very useful if we realize that new values can be easily assigned to subsets. This works for any of the examples above. For instance,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Where nums1 was 100, make it -100</span>
nums1[nums1 <span class="op">==</span><span class="st"> </span><span class="dv">100</span>] &lt;-<span class="st"> </span><span class="dv">-100</span>

<span class="co"># Where nums2 was less than 5, make it zero</span>
nums2[nums2 <span class="op">&lt;</span><span class="st"> </span><span class="dv">5</span>] &lt;-<span class="st"> </span><span class="dv">0</span></code></pre>

<div class="rmdtry">
Using the first set of examples in this section, practice assigning new values to subsets of vectors.
</div>

</div>
</div>
<div id="subsetdataframes" class="section level3">
<h3><span class="header-section-number">3.5.2</span> Dataframes</h3>
<p>In base R, there are two ways to take a subset of a dataframe: using the square bracket notation (<code>[]</code>) as in the above examples, or using the <code>filter</code> function from the <code>dplyr</code> package. We will learn both, as they are both useful from time to time.</p>
<p>Similar to vectors, dataframes can be indexed with row and column numbers using <code>mydataframe[row,column]</code>.</p>
<p>Here, <code>row</code> refers to the row number (which can be a vector of any length), and <code>column</code> to the column number (which can also be a vector). You can also refer to the column by its <em>name</em> rather than its number, which can be very useful. All this will become clearer after some examples.</p>
<p>Let’s look at a few examples using the Allometry dataset.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load data</span>
<span class="kw">data</span>(allometry)

<span class="co"># Extract tree diameters: take the 4th observation of the 2nd variable:</span>
allometry[<span class="dv">4</span>,<span class="dv">2</span>]</code></pre>
<pre><code>## [1] 28.7</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We can also index the dataframe by its variable name:</span>
allometry[<span class="dv">4</span>,<span class="st">&quot;diameter&quot;</span>]</code></pre>
<pre><code>## [1] 28.7</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract the first 3 rows of &#39;height&#39;:</span>
allometry[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="st">&quot;height&quot;</span>]</code></pre>
<pre><code>## [1] 27.04 27.42 21.23</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract the first 5 rows, of ALL variables</span>
<span class="co"># Note the use of the comma followed by nothing</span>
<span class="co"># This means &#39;every column&#39; and is very useful!</span>
allometry[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,]</code></pre>
<pre><code>##   species diameter height   leafarea branchmass
## 1    PSME    54.61  27.04 338.485622  410.24638
## 2    PSME    34.80  27.42 122.157864   83.65030
## 3    PSME    24.89  21.23   3.958274    3.51270
## 4    PSME    28.70  24.96  86.350653   73.13027
## 5    PSME    34.80  29.99  63.350906   62.39044</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract the fourth column</span>
<span class="co"># Here we use nothing, followed by a comma,</span>
<span class="co"># to indicate &#39;every row&#39;</span>
allometry[,<span class="dv">4</span>]</code></pre>
<pre><code>##  [1] 338.485622 122.157864   3.958274  86.350653  63.350906  61.372765
##  [7]  32.077794 147.270523 141.787332  45.020041 145.809802 349.057010
## [13] 176.029213 319.507115 234.368784   4.851567   7.595163  11.502851
## [19]  25.380647  65.698749 160.839174  31.780702 189.733007 253.308265
## [25]  91.538428  90.453658  99.736790  34.464685  68.150309  46.326060
## [31] 160.993131   9.806496  20.743280  21.649603  66.633675  54.267994
## [37]  19.844680 131.727303  22.365837   2.636336 411.160376  15.476022
## [43]  14.493428 169.053644 139.651156 376.308256 417.209436 103.672633
## [49]  33.713580 116.154916  44.934469  18.855867 154.078625  70.602797
## [55] 169.163842   7.650902  93.072006 277.494360 131.856837 121.428976
## [61] 212.443589  82.093031   6.551044</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select only &#39;height&#39; and &#39;diameter&#39;, store in new dataframe:</span>
allomhd &lt;-<span class="st"> </span>allometry[,<span class="kw">c</span>(<span class="st">&quot;height&quot;</span>, <span class="st">&quot;diameter&quot;</span>)]</code></pre>
<p>As we saw when working with vectors (see Section <a href="summarize.html#vectorindexing">3.5.1</a>), we can use expressions to extract data. Because each column in a dataframe is a vector, we can apply the same techniques to dataframes, as in the following examples.</p>
<p>We can also use one vector in a dataframe to find subsets of another. For example, what if we want to find the value of one vector, if another vector has a particular value?</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract diameters larger than 60</span>
allometry<span class="op">$</span>diameter[allometry<span class="op">$</span>diameter <span class="op">&gt;</span><span class="st"> </span><span class="dv">60</span>]</code></pre>
<pre><code>## [1] 69.85 69.60 60.20 70.61 60.20 60.71 70.61 73.66 61.47</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract all rows of allom where diameter is larger than 60.</span>
<span class="co"># Make sure you understand the difference with the above example!</span>
allometry[allometry<span class="op">$</span>diameter <span class="op">&gt;</span><span class="st"> </span><span class="dv">60</span>,]</code></pre>
<pre><code>##    species diameter height leafarea branchmass
## 12    PSME    69.85  31.35 349.0570   543.9731
## 23    PIPO    69.60  39.37 189.7330   452.4246
## 38    PIPO    60.20  31.73 131.7273   408.3383
## 41    PIPO    70.61  31.93 411.1604  1182.4222
## 44    PIPO    60.20  35.14 169.0536   658.2397
## 45    PIMO    60.71  39.84 139.6512   139.2559
## 46    PIMO    70.61  40.66 376.3083   541.3062
## 58    PIMO    73.66  44.64 277.4944   275.7165
## 60    PIMO    61.47  44.99 121.4290   199.8634</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We can use one vector to index another. For example, find the height of the tree</span>
<span class="co"># that has the largest diameter, we can do:</span>
allometry<span class="op">$</span>height[<span class="kw">which.max</span>(allometry<span class="op">$</span>diameter)]</code></pre>
<pre><code>## [1] 44.64</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Recalling the previous section, this is identical to:</span>
allometry[<span class="kw">which.max</span>(allometry<span class="op">$</span>diameter), <span class="st">&quot;height&quot;</span>]</code></pre>
<pre><code>## [1] 44.64</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Get 10 random observations of &#39;leafarea&#39;. Here, we make a new vector </span>
<span class="co"># on the fly with sample(), which we use to index the dataframe.</span>
allometry[<span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(allometry),<span class="dv">10</span>),<span class="st">&quot;leafarea&quot;</span>]</code></pre>
<pre><code>##  [1] 319.50711 131.72730  21.64960  15.47602  18.85587  45.02004  46.32606
##  [8] 417.20944 169.16384  19.84468</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># As we did with vectors, we can also use %in% to select a subset.</span>
<span class="co"># This example selects only two species in the dataframe.</span>
allometry[allometry<span class="op">$</span>species <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;PIMO&quot;</span>,<span class="st">&quot;PIPO&quot;</span>),]</code></pre>
<pre><code>##    species diameter    height   leafarea branchmass
## 23    PIPO    69.60 39.369999 189.733007  452.42455
## 24    PIPO    58.42 35.810000 253.308265  595.64015
## 25    PIPO    33.27 20.800001  91.538428  160.44416
## 26    PIPO    44.20 29.110001  90.453658  149.72883
## 27    PIPO    30.48 22.399999  99.736790   44.13532
## 28    PIPO    27.43 27.690001  34.464685   22.98360
## 29    PIPO    43.18 35.580000  68.150309  106.40410
## 30    PIPO    38.86 33.120001  46.326060   58.24071
## 31    PIPO    52.58 41.160003 160.993131  214.34109
## 32    PIPO    20.83 23.340000   9.806496    8.25614
## 33    PIPO    24.13 25.940001  20.743280   22.60111
## 34    PIPO    24.89 25.110000  21.649603   16.77015
## 35    PIPO    45.97 30.389999  66.633675   87.36908
## 36    PIPO    35.05 28.399999  54.267994   51.09006
## 37    PIPO    23.88 23.380001  19.844680   13.98343
## 38    PIPO    60.20 31.729999 131.727303  408.33826
## 39    PIPO    12.45  7.360001  22.365837   16.98648
## 40    PIPO     4.83  3.570000   2.636336    1.77810
## 41    PIPO    70.61 31.929997 411.160376 1182.42222
## 42    PIPO    11.43  6.920000  15.476022    9.25151
## 43    PIPO    11.94  5.849999  14.493428    7.55701
## 44    PIPO    60.20 35.139998 169.053644  658.23971
## 45    PIMO    60.71 39.840003 139.651156  139.25590
## 46    PIMO    70.61 40.659999 376.308256  541.30618
## 47    PIMO    57.66 38.889998 417.209436  310.56688
## 48    PIMO    43.13 36.240000 103.672633  100.40178
## 49    PIMO    18.29 23.130000  33.713580   14.48567
## 50    PIMO    43.43 37.589998 116.154916  108.44781
## 51    PIMO    18.54 21.289999  44.934469   16.54457
## 52    PIMO    12.95 13.440000  18.855867    8.71068
## 53    PIMO    37.85 36.590000 154.078625   72.02907
## 54    PIMO    26.92 29.049999  70.602797   35.87333
## 55    PIMO    38.61 35.519999 169.163842  114.06445
## 56    PIMO     6.48  5.420000   7.650902    3.50621
## 57    PIMO    31.75 34.559999  93.072006   44.72725
## 58    PIMO    73.66 44.640000 277.494360  275.71655
## 59    PIMO    28.19 22.590000 131.856837   91.76231
## 60    PIMO    61.47 44.989998 121.428976  199.86339
## 61    PIMO    51.56 40.229999 212.443589  220.55688
## 62    PIMO    18.29 12.980000  82.093031   28.04785
## 63    PIMO     8.38  4.950000   6.551044    4.36969</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract tree diameters for the PIMO species, as long as diameter &gt; 50</span>
allometry<span class="op">$</span>diameter[allometry<span class="op">$</span>species <span class="op">==</span><span class="st"> &quot;PIMO&quot;</span> <span class="op">&amp;</span><span class="st"> </span>allometry<span class="op">$</span>diameter <span class="op">&gt;</span><span class="st"> </span><span class="dv">50</span>]</code></pre>
<pre><code>## [1] 60.71 70.61 57.66 73.66 61.47 51.56</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># (not all output shown)</span></code></pre>

<div class="rmdtry">
As with vectors, we can quickly assign new values to subsets of data using the <code>&lt;-</code> operator. Try this on some of the examples above.
</div>

</div>
<div id="a-faster-method" class="section level3">
<h3><span class="header-section-number">3.5.3</span> A faster method</h3>
<p>While the above method to index dataframes is very flexible and concise, sometimes it leads to code that is difficult to understand. It is also easy to make mistakes when you subset dataframes by the column or row number (imagine the situation where the dataset has changed and you redo the analysis). Consider the <code>filter</code> function as a convenient and safe alternative, from the <code>dplyr</code> package. (Note that base R provides a nearly identical function, <code>subset</code>, but <code>filter</code> is much faster).</p>
<p>With <code>filter</code>, you can select rows that meet a certain criterion, and columns as well. This example uses the pupae data. The last example shows the use of <code>select</code> from <code>dplyr</code> to keep only certain columns, conveniently with the pipe operator.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read data</span>
<span class="kw">data</span>(pupae)

<span class="co"># For filter(), select().</span>
<span class="kw">library</span>(dplyr)

<span class="co"># Take subset of pupae, ambient temperature treatment and CO2 is 280.</span>
<span class="co"># Note: statements separated by commas are interpreted as AND by filter()</span>
<span class="kw">filter</span>(pupae, 
       T_treatment <span class="op">==</span><span class="st"> &quot;ambient&quot;</span>,
       CO2_treatment <span class="op">==</span><span class="st"> </span><span class="dv">280</span>,
       Gender <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</code></pre>
<pre><code>##   T_treatment CO2_treatment Gender PupalWeight Frass
## 1     ambient           280      0       0.244 1.900
## 2     ambient           280      0       0.221    NA
## 3     ambient           280      0       0.280 1.996
## 4     ambient           280      0       0.257 1.069
## 5     ambient           280      0       0.275 2.198
## 6     ambient           280      0       0.254 2.220
## 7     ambient           280      0       0.258 1.877
## 8     ambient           280      0       0.224 1.488</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># (not all output shown)</span>

<span class="co"># Take subset where Frass is larger than 2.9. </span>
<span class="co"># Also, keep only variables &#39;PupalWeight&#39; and &#39;Frass&#39;.</span>
<span class="kw">filter</span>(pupae, Frass <span class="op">&gt;</span><span class="st"> </span><span class="fl">2.6</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(PupalWeight, Frass)</code></pre>
<pre><code>##   PupalWeight Frass
## 1       0.319 2.770
## 2       0.384 2.672
## 3       0.385 2.603
## 4       0.405 3.117
## 5       0.473 2.631
## 6       0.469 2.747</code></pre>
</div>
<div id="deleting-columns" class="section level3">
<h3><span class="header-section-number">3.5.4</span> Deleting columns</h3>
<p>It is rarely necessary to delete columns from a dataframe, unless you want to save a copy of the dataframe to disk (see Section <a href="summarize.html#exportingdata">3.6</a>). Instead of deleting columns, you can take a subset and make a new dataframe to continue with. Also, it should not be necessary to delete columns from the dataframe that you have accidentally created in a reproducible script: when things go wrong, simply clear the workspace and run the entire script again.</p>
<p>That aside, you have the following options to delete a column from a dataframe.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A simple example dataframe</span>
dfr &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a=</span><span class="op">-</span><span class="dv">5</span><span class="op">:</span><span class="dv">0</span>, <span class="dt">b=</span><span class="dv">10</span><span class="op">:</span><span class="dv">15</span>)

<span class="co"># Delete the second column (make a new dataframe &#39;dfr2&#39; that does not include that column)</span>
<span class="co"># This only works if you know the column index (here, 2) for sure,</span>
<span class="co"># it does not work with a column name!</span>
dfr2 &lt;-<span class="st"> </span>dfr[,<span class="op">-</span><span class="dv">2</span>]

<span class="co"># Using select() from the dplyr, we can drop columns by name:</span>
dfr2 &lt;-<span class="st"> </span><span class="kw">select</span>(dfr, <span class="op">-</span>a)</code></pre>
</div>
</div>
<div id="exportingdata" class="section level2">
<h2><span class="header-section-number">3.6</span> Exporting data</h2>
<p>To write a dataframe to a comma-separated values (CSV) file, use the <code>write.csv</code> function. For example,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Some data</span>
dfr &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">y=</span><span class="dv">2</span><span class="op">:</span><span class="dv">4</span>)

<span class="co"># Write to disk (row names are generally not wanted in the CSV file).</span>
<span class="kw">write.csv</span>(dfr,<span class="st">&quot;somedata.csv&quot;</span>, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</code></pre>
<p>If you want more options, or a different delimiter (such as TAB), look at the <code>write.table</code> function. Note that if you write a dataset to a text file, and read it back in with <code>read.csv</code> (or <code>read.table</code>), the dataset will not be exactly the same. One reason is the number of digits used in the text file, or that you have converted some columns to character, numeric, or whatever.</p>
<p>If you want to store a dataframe to disk, and later read it back into R exactly as it was before, it is preferred to use a <strong>binary format</strong>. This idea works for any R object, not just dataframes:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Much faster than writing text files, resulting files are much smaller,</span>
<span class="co"># and objects are saved exactly as they were in R.</span>
<span class="kw">saveRDS</span>(dfr, <span class="st">&quot;somefile.rds&quot;</span>)

<span class="co"># To read the object back in, do:</span>
dfr &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;somefile.rds&quot;</span>)</code></pre>
<p>It is also possible to save all objects that are currently loaded in memory (everything that shows up with <code>ls()</code>) with the command <code>save.image</code>. However, we strongly urge against it, as it is easy to lose track of which objects are important, and it is too easy to make a mess of things. A fresh installation of Rstudio saves all your objects after you quit Rstudio, but as we mentioned in Section <a href="intro.html#installingr">2.1</a>, we suggest you switch that behaviour off.</p>
</div>
<div id="special-data-types" class="section level2">
<h2><span class="header-section-number">3.7</span> Special data types</h2>
<p>Now that we know how to read in dataframes, it is time we take a closer look at the types of data that can be contained in a dataframe. For the purpose of this book, a dataframe can contain six types of data. These are summarized in the table below:</p>
<table>
<thead>
<tr class="header">
<th align="left">Data type</th>
<th align="left">Description</th>
<th align="left">Example</th>
<th align="left">Section</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><em>numeric</em></td>
<td align="left">Any number, including <code>double</code> (double precision floating point) and <code>integer</code> (whole numbers). In R you very rarely have to worry about the exact nature of numeric values.</td>
<td align="left"><code>c(1, 12.3491, 10/2, 10^6, pi)</code></td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left"><em>character</em></td>
<td align="left">Strings of text</td>
<td align="left"><code>c('apple', 'pear', letters[1:3])</code></td>
<td align="left"><a href="summarize.html#workingtext">3.7.4</a></td>
</tr>
<tr class="odd">
<td align="left"><em>factor</em></td>
<td align="left">Categorial variable. Preferred over character when few unique levels (values) present in the data. Must use in statistical models, plotting. Internally stored as an integer corresponding to the <em>level</em> of the factor variable.</td>
<td align="left"><code>factor(c('Control','Fertilized','Irrigated'))</code></td>
<td align="left"><a href="summarize.html#workingfactors">3.7.1</a></td>
</tr>
<tr class="even">
<td align="left"><em>logical</em></td>
<td align="left">Either TRUE or FALSE. Internally stored as 0 (FALSE) or 1 (TRUE).</td>
<td align="left"><code>10 == 100/10</code></td>
<td align="left"><a href="summarize.html#workinglogic">3.7.2</a></td>
</tr>
<tr class="odd">
<td align="left"><em>Date</em></td>
<td align="left">Special Date class. Internally stored as number of days since 1970-1-1.</td>
<td align="left"><code>as.Date(Sys.time())</code></td>
<td align="left"><a href="summarize.html#readingdates">3.7.5.1</a></td>
</tr>
<tr class="even">
<td align="left"><em>POSIXct</em></td>
<td align="left">Special Date-time class. Internally stored as number of seconds since 1970-1-1, and may have timezone attributes.</td>
<td align="left"><code>lubridate::ymd_hms('1883-08-26 14:00')</code></td>
<td align="left"><a href="summarize.html#datetime">3.7.5.3</a></td>
</tr>
</tbody>
</table>
<p>Also, R has a very useful built-in data type to represent <strong>missing values</strong>. This is represented by <code>NA</code> (Not Available) (see Section <a href="summarize.html#workingmissing">3.7.3</a>).</p>
<p>We will show how to convert between data types at the end of this chapter (Section <a href="summarize.html#converttype">3.7.6</a>).</p>
<div id="workingfactors" class="section level3">
<h3><span class="header-section-number">3.7.1</span> Working with factors</h3>
<p>The <em>factor</em> data type is used to represent qualitative, categorical data.</p>
<p>When reading data from file, for example with <code>read.csv</code>, R will automatically convert any variable to a factor if it is unable to convert it to a numeric variable. If a variable is actually numeric, but you want to treat it as a factor, you can use <code>as.factor</code> to convert it, as in the following example.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Make sure you have loaded the lgrdata package</span>
<span class="kw">data</span>(pupae)

<span class="co"># This dataset contains a temperature (T_treatment) and CO2 treatment (CO2_treatment).</span>
<span class="co"># Both should logically be factors, however, CO2_treatment is read as numeric:</span>
<span class="kw">str</span>(pupae)</code></pre>
<pre><code>## &#39;data.frame&#39;:    84 obs. of  5 variables:
##  $ T_treatment  : Factor w/ 2 levels &quot;ambient&quot;,&quot;elevated&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ CO2_treatment: int  280 280 280 280 280 280 280 280 280 280 ...
##  $ Gender       : int  0 1 0 0 0 1 0 1 0 1 ...
##  $ PupalWeight  : num  0.244 0.319 0.221 0.28 0.257 0.333 0.275 0.312 0.254 0.356 ...
##  $ Frass        : num  1.9 2.77 NA 2 1.07 ...</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># To convert it to a factor, we use:</span>
pupae<span class="op">$</span>CO2_treatment &lt;-<span class="st"> </span><span class="kw">as.factor</span>(pupae<span class="op">$</span>CO2_treatment)

<span class="co"># Compare with the above,</span>
<span class="kw">str</span>(pupae)</code></pre>
<pre><code>## &#39;data.frame&#39;:    84 obs. of  5 variables:
##  $ T_treatment  : Factor w/ 2 levels &quot;ambient&quot;,&quot;elevated&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ CO2_treatment: Factor w/ 2 levels &quot;280&quot;,&quot;400&quot;: 1 1 1 1 1 1 1 1 1 1 ...
##  $ Gender       : int  0 1 0 0 0 1 0 1 0 1 ...
##  $ PupalWeight  : num  0.244 0.319 0.221 0.28 0.257 0.333 0.275 0.312 0.254 0.356 ...
##  $ Frass        : num  1.9 2.77 NA 2 1.07 ...</code></pre>
<p>In the <code>allometry</code> example dataset, the <code>species</code> variable is a good example of a factor. A factor variable has a number of ‘levels’, which are the text values that the variable has in the dataset. Factors can also represent treatments of an experimental study. For example,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(allometry)
<span class="kw">levels</span>(allometry<span class="op">$</span>species)</code></pre>
<pre><code>## [1] &quot;PIMO&quot; &quot;PIPO&quot; &quot;PSME&quot;</code></pre>
<p>Shows the three species in this dataset. We can also count the number of rows in the dataframe for each species, like this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(allometry<span class="op">$</span>species)</code></pre>
<pre><code>## 
## PIMO PIPO PSME 
##   19   22   22</code></pre>
<p>Note that the three species are always shown in the order of the <strong>levels of the factor</strong>: when the dataframe was read, these levels were assigned based on alphabetical order. Often, this is not a very logical order, and you may want to rearrange the levels to get more meaningful results.</p>
<p>In our example, let’s shuffle the levels around, using <code>factor</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">allometry<span class="op">$</span>species &lt;-<span class="st"> </span><span class="kw">factor</span>(allometry<span class="op">$</span>species, <span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;PSME&quot;</span>,<span class="st">&quot;PIMO&quot;</span>,<span class="st">&quot;PIPO&quot;</span>))</code></pre>
<p>Now revisit the commands above, and note that the results are the same, but the order of the <code>levels</code> of
the <code>factor</code> is different. You can also reorder the levels of a factor by the values of another variable, see the example in Section <a href="summarize.html#reorder">3.8.4</a>.</p>
<div id="turn-numeric-data-into-factors" class="section level4">
<h4><span class="header-section-number">3.7.1.1</span> Turn numeric data into factors</h4>
<p>We can also generate new factors, and add them to the dataframe. This is a common application:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Add a new variable to allom:  &#39;small&#39; when diameter is less than 10, &#39;large&#39; otherwise.</span>
allometry<span class="op">$</span>treeSizeClass &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">ifelse</span>(allometry<span class="op">$</span>diameter <span class="op">&lt;</span><span class="st"> </span><span class="dv">10</span>, <span class="st">&quot;small&quot;</span>, <span class="st">&quot;large&quot;</span>))

<span class="co"># Now, look how many trees fall in each class.</span>
<span class="co"># Note that somewhat confusingly, &#39;large&#39; is printed before &#39;small&#39;.</span>
<span class="co"># Once again, this is because the order of the factor levels is alphabetical by default.</span>
<span class="kw">table</span>(allometry<span class="op">$</span>treeSizeClass)</code></pre>
<pre><code>## 
## large small 
##    56     7</code></pre>
<p>What if we want to add a new factor based on a numeric variable with more than two levels? In that case, we cannot use <code>ifelse</code>. We must find a different method. Look at this example using <code>cut</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The cut function takes a numeric vectors and cuts it into a categorical variable.</span>
<span class="co"># Continuing the example above, let&#39;s make &#39;small&#39;,&#39;medium&#39; and &#39;large&#39; tree size classes:</span>
allometry<span class="op">$</span>treeSizeClass &lt;-<span class="st"> </span><span class="kw">cut</span>(allometry<span class="op">$</span>diameter, <span class="dt">breaks=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">75</span>), 
                           <span class="dt">labels=</span><span class="kw">c</span>(<span class="st">&quot;small&quot;</span>,<span class="st">&quot;medium&quot;</span>,<span class="st">&quot;large&quot;</span>))

<span class="co"># And the results,</span>
<span class="kw">table</span>(allometry<span class="op">$</span>treeSizeClass)</code></pre>
<pre><code>## 
##  small medium  large 
##     22     24     17</code></pre>
</div>
<div id="empty-factor-levels" class="section level4">
<h4><span class="header-section-number">3.7.1.2</span> Empty factor levels</h4>
<p>It is important to understand how factors are used in R: they are not simply text variables, or ‘character strings’. Each unique value of a factor variable is assigned a <em>level</em>, which is used every time you summarize your data by the factor variable.</p>
<p>Crucially, even when you delete data, the original factor <em>level</em> is still present. Although this behaviour might seem strange, it makes a lot of sense in many cases (zero observations for a particular factor level can be quite informative!).</p>
<p>Sometimes it is more convenient to drop empty factor levels with the <code>droplevels</code> function. Consider this example:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Note that &#39;T_treatment&#39; (temperature treatment) is a factor with two levels,</span>
<span class="co"># with 37 and 47 observations in total:</span>
<span class="kw">table</span>(pupae<span class="op">$</span>T_treatment)</code></pre>
<pre><code>## 
##  ambient elevated 
##       37       47</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Suppose we decide to keep only the ambient treatment:</span>
pupae_amb &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(pupae, T_treatment <span class="op">==</span><span class="st"> &quot;ambient&quot;</span>)

<span class="co"># Now, the level is still present, although empty:</span>
<span class="kw">table</span>(pupae_amb<span class="op">$</span>T_treatment)</code></pre>
<pre><code>## 
##  ambient elevated 
##       37        0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># In this case, we don&#39;t want to keep the empty factor level.</span>
<span class="co"># Use droplevels to get rid of any empty levels:</span>
pupae_amb2 &lt;-<span class="st"> </span><span class="kw">droplevels</span>(pupae_amb)</code></pre>

<div class="rmdtry">
Compare the <code>summary</code> of <code>pupae_amb</code> and <code>pupae_amb2</code>, and note the differences.
</div>

</div>
<div id="changelevels" class="section level4">
<h4><span class="header-section-number">3.7.1.3</span> Changing the levels of a factor</h4>
<p>Sometimes you may want to change the levels of a factor, for example to replace abbreviations with more readable labels. To do this, we can assign new values with the <code>levels</code> function, as in the following example using the pupae data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Change the levels of T_treatment by assigning a character vector to the levels.</span>
<span class="kw">levels</span>(pupae<span class="op">$</span>T_treatment) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ambient&quot;</span>,<span class="st">&quot;Ambient + 3C&quot;</span>)

<span class="co"># Or only change the first level, using subscripting.</span>
<span class="kw">levels</span>(pupae<span class="op">$</span>T_treatment)[<span class="dv">1</span>] &lt;-<span class="st"> &quot;Control&quot;</span></code></pre>

<div class="rmdtry">
Using the method above, you can also merge levels of a factor, simply by assigning the same new level to both old levels. Try this on a dataset of your choice (for example, in the <code>allom</code> data, you can assign new species levels, ‘Douglas-fir’ for PSME, and ‘Pine’ for both PIMO and PIPO). Then check the results with <code>levels()</code>.
</div>

</div>
</div>
<div id="workinglogic" class="section level3">
<h3><span class="header-section-number">3.7.2</span> Working with logical data</h3>
<p>Some data can only take two values: true, or false. For data like these, R has the <em>logical</em> data type.</p>
<p>The following examples use various logical operators, and all return TRUE or FALSE, or a vector of them. The help page <code>?Syntax</code> has a comprehensive list of operators in R (including the logical operators).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Answers to (in)equalities are always logical:</span>
<span class="dv">10</span> <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span></code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="dv">101</span> <span class="op">==</span><span class="st"> </span><span class="dv">100</span> <span class="op">+</span><span class="st"> </span><span class="dv">1</span></code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ... or use objects for comparison:</span>
apple &lt;-<span class="st"> </span><span class="dv">2</span>
pear &lt;-<span class="st"> </span><span class="dv">3</span>
apple <span class="op">==</span><span class="st"> </span>pear</code></pre>
<pre><code>## [1] FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># NOT equal to.</span>
apple <span class="op">!=</span><span class="st"> </span>pear</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Logical comparisons like these also work for vectors, for example:</span>
nums &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">21</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">12</span>)
nums <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span></code></pre>
<pre><code>## [1]  TRUE  TRUE FALSE  TRUE FALSE FALSE  TRUE</code></pre>
<p>The functions <code>which</code>, <code>any</code> and <code>all</code> are very useful to know when working with logical data:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Find which of the numbers are larger than 5:</span>
<span class="kw">which</span>(nums <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span>)</code></pre>
<pre><code>## [1] 1 2 4 7</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Other useful functions are &#39;any&#39; and &#39;all&#39;:</span>
<span class="co"># Are any numbers larger than 25?</span>
<span class="kw">any</span>(nums <span class="op">&gt;</span><span class="st"> </span><span class="dv">25</span>)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Are all numbers less than or equal to 10?</span>
<span class="kw">all</span>(nums <span class="op">&lt;=</span><span class="st"> </span><span class="dv">10</span>)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<p>You have already been using logical data when we filtered dataframes and vectors:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Use &amp; for AND, for example to take subsets where two conditions are met:</span>
<span class="kw">subset</span>(pupae, PupalWeight <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.4</span> <span class="op">&amp;</span><span class="st"> </span>Frass <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>)</code></pre>
<pre><code>##    T_treatment CO2_treatment Gender PupalWeight Frass
## 25     ambient           400      1       0.405 3.117</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Use | for OR</span>
nums[nums <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span> <span class="op">|</span><span class="st"> </span>nums <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span>]</code></pre>
<pre><code>## [1] 21  0  1</code></pre>
<p>Logical data are coded by integer numbers (0 = <code>FALSE</code>, 1 = <code>TRUE</code>), but normally you don’t see this, since R will only <em>print</em> <code>TRUE</code> and <code>FALSE</code> ‘labels’. However, once you know this, some analyses become even easier.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># How many numbers are larger than 5?</span>
<span class="co">#- Short solution</span>
<span class="kw">sum</span>(nums <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span>)</code></pre>
<pre><code>## [1] 4</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#- Long solution</span>
<span class="kw">length</span>(nums[nums <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span>])</code></pre>
<pre><code>## [1] 4</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># What fraction of data is larger than some value?</span>
<span class="kw">mean</span>(pupae<span class="op">$</span>PupalWeight <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.3</span>)</code></pre>
<pre><code>## [1] 0.4880952</code></pre>
</div>
<div id="workingmissing" class="section level3">
<h3><span class="header-section-number">3.7.3</span> Working with missing values</h3>
<p>In R, missing values are represented with <code>NA</code>, a special data type that indicates the data is simply <em>Not Available</em>.</p>
<p>Many functions can handle missing data, usually in different ways. For example, suppose we have the following vector:</p>
<pre class="sourceCode r"><code class="sourceCode r">myvec1 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">11</span>,<span class="dv">13</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="ot">NA</span>,<span class="dv">9</span>)</code></pre>
<p>In order to calculate the mean, we might want to either exclude the missing value (and calculate the mean of the remaining five numbers), or we might want <code>mean(myvec1)</code> to fail (produce an error). This last case is useful if we don’t expect missing values, and want R to only calculate the mean when there are no <code>NA</code>’s in the dataset.</p>
<p>These two options are shown in this example:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate mean: this fails if there are missing values</span>
<span class="kw">mean</span>(myvec1)</code></pre>
<pre><code>## [1] NA</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate mean after removing the missing values</span>
<span class="kw">mean</span>(myvec1, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</code></pre>
<pre><code>## [1] 8.8</code></pre>
<p>Many functions have an argument <code>na.rm</code>, or similar. Refer to the help page of the function to learn about the various options (if any) for dealing with missing values. For example, see the help pages <code>?lm</code> and <code>?sd</code>.</p>
<p>The function <code>is.na</code> returns <code>TRUE</code> when a value is missing, which can be useful to see which values are missing, or how many,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Is a value missing? (TRUE or FALSE)</span>
<span class="kw">is.na</span>(myvec1)</code></pre>
<pre><code>## [1] FALSE FALSE FALSE FALSE  TRUE FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Which of the elements of a vector is missing?</span>
<span class="kw">which</span>(<span class="kw">is.na</span>(myvec1))</code></pre>
<pre><code>## [1] 5</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># How many values in a vector are NA?</span>
<span class="kw">sum</span>(<span class="kw">is.na</span>(myvec1))  </code></pre>
<pre><code>## [1] 1</code></pre>
<div id="making-missing-values" class="section level4">
<h4><span class="header-section-number">3.7.3.1</span> Making missing values</h4>
<p>In many cases it is useful to change some bad data values to <code>NA</code>. We can use our indexing skills to do so,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Some vector that contains bad values coded as -9999</span>
datavec &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>,<span class="op">-</span><span class="dv">9999</span>,<span class="dv">100</span>,<span class="dv">3</span>,<span class="op">-</span><span class="dv">9999</span>,<span class="dv">5</span>)

<span class="co"># Assign NA to the values that were -9999</span>
datavec[datavec <span class="op">==</span><span class="st"> </span><span class="dv">-9999</span>] &lt;-<span class="st"> </span><span class="ot">NA</span> </code></pre>
<p>In other cases, missing values arise when certain operations did not produce the desired result. Consider this example,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A character vector, some of these look like numbers:</span>
myvec &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;101&quot;</span>,<span class="st">&quot;289&quot;</span>,<span class="st">&quot;12.3&quot;</span>,<span class="st">&quot;abc&quot;</span>,<span class="st">&quot;99&quot;</span>)

<span class="co"># Convert the vector to numeric:</span>
<span class="kw">as.numeric</span>(myvec)</code></pre>
<pre><code>## Warning: NAs introduced by coercion</code></pre>
<pre><code>## [1] 101.0 289.0  12.3    NA  99.0</code></pre>
<p>The warning message <strong>NAs introduced by coercion</strong> means that missing values were produced by when we tried to turn one data type (character) to another (numeric).</p>
</div>
<div id="not-a-number" class="section level4">
<h4><span class="header-section-number">3.7.3.2</span> Not A Number</h4>
<p>Another type of missing value is the result of calculations that went wrong, for example:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Attempt to take the logarithm of a negative number:</span>
<span class="kw">log</span>(<span class="op">-</span><span class="dv">1</span>)</code></pre>
<pre><code>## Warning in log(-1): NaNs produced</code></pre>
<pre><code>## [1] NaN</code></pre>
<p>The result is <code>NaN</code>, short for <em>Not A Number</em>.</p>
<p>Dividing by zero is not usually meaningful, but R does not produce a missing value:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="dv">1000</span><span class="op">/</span><span class="dv">0</span></code></pre>
<pre><code>## [1] Inf</code></pre>
<p>It produces ‘Infinity’ instead.</p>
</div>
<div id="naindataframe" class="section level4">
<h4><span class="header-section-number">3.7.3.3</span> Missing values in dataframes</h4>
<p>When working with dataframes, you often want to remove missing values for a particular analysis. We’ll use the <code>pupae</code> dataset for the following examples. Note we use the <code>dplyr</code> package for <code>filter</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># (re-)load data</span>
<span class="kw">data</span>(pupae)

<span class="co"># Look at a summary to see if there are missing values:</span>
<span class="kw">summary</span>(pupae)</code></pre>
<pre><code>##    T_treatment CO2_treatment       Gender        PupalWeight    
##  ambient :37   Min.   :280.0   Min.   :0.0000   Min.   :0.1720  
##  elevated:47   1st Qu.:280.0   1st Qu.:0.0000   1st Qu.:0.2562  
##                Median :400.0   Median :0.0000   Median :0.2975  
##                Mean   :344.3   Mean   :0.4487   Mean   :0.3110  
##                3rd Qu.:400.0   3rd Qu.:1.0000   3rd Qu.:0.3560  
##                Max.   :400.0   Max.   :1.0000   Max.   :0.4730  
##                                NA&#39;s   :6                        
##      Frass      
##  Min.   :0.986  
##  1st Qu.:1.515  
##  Median :1.818  
##  Mean   :1.846  
##  3rd Qu.:2.095  
##  Max.   :3.117  
##  NA&#39;s   :1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Notice there are 6 NA&#39;s (missing values) for Gender, and 1 for Frass.</span>

<span class="co"># Option 1: take subset of data where Gender is not missing:</span>
pupae_subs1 &lt;-<span class="st"> </span><span class="kw">filter</span>(pupae, <span class="op">!</span><span class="kw">is.na</span>(Gender))

<span class="co"># Option 2: take subset of data where Frass AND Gender are not missing</span>
pupae_subs2 &lt;-<span class="st"> </span><span class="kw">filter</span>(pupae, 
                      <span class="op">!</span><span class="kw">is.na</span>(Frass),
                      <span class="op">!</span><span class="kw">is.na</span>(Gender))

<span class="co"># A more rigorous subset: remove all rows from a dataset where ANY variable </span>
<span class="co"># has a missing value:</span>
pupae_nona &lt;-<span class="st"> </span>pupae[<span class="kw">complete.cases</span>(pupae),]

<span class="co"># This was an example where indexing (using square brackets) is a bit more </span>
<span class="co"># convenient than the dplyr approach, where we have to write the following.</span>
<span class="co"># A number of similar looking statements do not work!</span>
pupae_nona &lt;-<span class="st"> </span>pupae <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">complete.cases</span>(.))</code></pre>
</div>
<div id="subsetmissing" class="section level4">
<h4><span class="header-section-number">3.7.3.4</span> Subsetting when there are missing values</h4>
<p>When there are missing values in a vector, and you take a subset (for example all data larger than some value), should the missing values be included or dropped? There is no one answer to this, but it is important to know that <code>subset</code> drops them, but the square bracket method (<code>[]</code>) keeps them.</p>
<p>Consider this example, and especially the use of <code>which</code> to drop missing values when subsetting.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A small dataframe</span>
dfr &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a=</span><span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">b=</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="ot">NA</span>,<span class="dv">6</span>,<span class="ot">NA</span>))

<span class="co"># subset drops all missing values</span>
<span class="co"># Note: dplyr::filter also drops NA</span>
<span class="kw">subset</span>(dfr, b <span class="op">&gt;</span><span class="st"> </span><span class="dv">4</span>, <span class="dt">select=</span>b)</code></pre>
<pre><code>##   b
## 3 6</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># square bracket notation keeps them</span>
dfr[dfr<span class="op">$</span>b <span class="op">&gt;</span><span class="st"> </span><span class="dv">4</span>,<span class="st">&quot;b&quot;</span>]</code></pre>
<pre><code>## [1] NA  6 NA</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ... but drops them when we use &#39;which&#39;</span>
dfr[<span class="kw">which</span>(dfr<span class="op">$</span>b <span class="op">&gt;</span><span class="st"> </span><span class="dv">4</span>),<span class="st">&quot;b&quot;</span>]</code></pre>
<pre><code>## [1] 6</code></pre>
</div>
</div>
<div id="workingtext" class="section level3">
<h3><span class="header-section-number">3.7.4</span> Working with text</h3>
<p>Many datasets include variables that are text only (think of comments, species names, locations, sample codes, and so on), it is useful to learn how to modify, extract, and analyse text-based (‘character’) variables.</p>
<p>Consider the following simple examples when working with a single character string:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Count number of characters in a bit of text:</span>
sentence &lt;-<span class="st"> &quot;Not a very long sentence.&quot;</span>
<span class="kw">nchar</span>(sentence)</code></pre>
<pre><code>## [1] 25</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract the first 3 characters:</span>
<span class="kw">substr</span>(sentence, <span class="dv">1</span>, <span class="dv">3</span>)</code></pre>
<pre><code>## [1] &quot;Not&quot;</code></pre>
<p>We can also apply these functions to a vector:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Substring all elements of a vector</span>
<span class="kw">substr</span>(<span class="kw">c</span>(<span class="st">&quot;good&quot;</span>,<span class="st">&quot;good riddance&quot;</span>,<span class="st">&quot;good on ya&quot;</span>),<span class="dv">1</span>,<span class="dv">4</span>)</code></pre>
<pre><code>## [1] &quot;good&quot; &quot;good&quot; &quot;good&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Number of characters of all elements of a vector</span>
<span class="kw">nchar</span>(<span class="kw">c</span>(<span class="st">&quot;hey&quot;</span>,<span class="st">&quot;hi&quot;</span>,<span class="st">&quot;how&quot;</span>,<span class="st">&quot;ya&quot;</span>,<span class="st">&quot;doin&quot;</span>))</code></pre>
<pre><code>## [1] 3 2 3 2 4</code></pre>
<div id="paste" class="section level4">
<h4><span class="header-section-number">3.7.4.1</span> Combining text</h4>
<p>To glue bits of text together, use the <code>paste</code> function, like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Add a suffix to each text element of a vector:</span>
txt &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;apple&quot;</span>,<span class="st">&quot;pear&quot;</span>,<span class="st">&quot;banana&quot;</span>)
<span class="kw">paste</span>(txt, <span class="st">&quot;fruit&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>)</code></pre>
<pre><code>## [1] &quot;apple-fruit&quot;  &quot;pear-fruit&quot;   &quot;banana-fruit&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Glue them all together into a single string using the collapse argument</span>
<span class="kw">paste</span>(txt, <span class="dt">collapse =</span> <span class="st">&quot;-&quot;</span>)</code></pre>
<pre><code>## [1] &quot;apple-pear-banana&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Combine numbers and text:</span>
<span class="kw">paste</span>(<span class="st">&quot;Question&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</code></pre>
<pre><code>## [1] &quot;Question 1&quot; &quot;Question 2&quot; &quot;Question 3&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This can be of use to make new variables in a dataframe,</span>
<span class="co"># as in this example where we combine two factors to create a new one:</span>
pupae<span class="op">$</span>T_CO2 &lt;-<span class="st"> </span><span class="kw">with</span>(pupae, <span class="kw">paste</span>(T_treatment, CO2_treatment, <span class="dt">sep=</span><span class="st">&quot;-&quot;</span>))
<span class="kw">head</span>(pupae<span class="op">$</span>T_CO2)</code></pre>
<pre><code>## [1] &quot;ambient-280&quot; &quot;ambient-280&quot; &quot;ambient-280&quot; &quot;ambient-280&quot; &quot;ambient-280&quot;
## [6] &quot;ambient-280&quot;</code></pre>

<div class="rmdtry">
Run the final example above, and inspect the variable <code>T_CO2</code> (with <code>str</code>) that we added to the dataframe. Make it into a factor variable using <code>as.factor</code>, and inspect the variable again.
</div>

</div>
<div id="textgrep" class="section level4">
<h4><span class="header-section-number">3.7.4.2</span> Text in dataframes and <code>grep</code></h4>
<p>When you read in a dataset (with <code>read.csv</code>, <code>read.table</code> or similar), any variable that R cannot convert to numeric <em>is automatically converted to a factor</em>. This means that if a column has even just one value that is text (or some garble that does not represent a number), the column cannot be numeric.</p>
<p>When you want non-numeric columns to be read in as <em>character</em> instead of <em>factor</em>, you must do:</p>
<pre class="sourceCode r"><code class="sourceCode r">cereals &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;cereals.csv&quot;</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</code></pre>
<p>Here, the argument <code>stringsAsFactors=FALSE</code> avoided the automatic conversion of character variables to factors.</p>
<p>While we know that factors are very useful, sometimes we want a variable to be treated like text. For example, if we plan to analyse text directly, or extract numbers or other information from bits of text. Let’s look at a few examples using the <code>titanic</code> dataset.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load dataset</span>
<span class="kw">data</span>(titanic)

<span class="co"># Is passenger name stored as a character?</span>
<span class="kw">is.character</span>(titanic<span class="op">$</span>Name)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Evidently not. We can convert it to character:</span>
titanic<span class="op">$</span>Name &lt;-<span class="st"> </span><span class="kw">as.character</span>(titanic<span class="op">$</span>Name)

<span class="co"># ... or as part of a dplyr chain:</span>
titanic &lt;-<span class="st"> </span>titanic <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Name =</span> <span class="kw">as.character</span>(Name))</code></pre>
<p>The following example uses <code>grep</code>, a very powerful function. This function can make use of <em>regular expressions</em>, a flexible tool for text processing.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract cereal names (for convenience).</span>
<span class="kw">data</span>(cereals)
cerealnames &lt;-<span class="st"> </span>cereals<span class="op">$</span>Cereal.name

<span class="co"># Find the cereals that have &#39;Raisin&#39; in them.</span>
<span class="co"># grep() returns the index of values that contain Raisin</span>
<span class="kw">grep</span>(<span class="st">&quot;Raisin&quot;</span>,cerealnames)</code></pre>
<pre><code>##  [1] 23 45 46 50 52 53 59 60 61 71</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># grepl() returns TRUE or FALSE</span>
<span class="kw">grepl</span>(<span class="st">&quot;Raisin&quot;</span>,cerealnames)</code></pre>
<pre><code>##  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [12] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [23]  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [34] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [45]  TRUE  TRUE FALSE FALSE FALSE  TRUE FALSE  TRUE  TRUE FALSE FALSE
## [56] FALSE FALSE FALSE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE FALSE
## [67] FALSE FALSE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># That result just gives you the indices of the vector that have &#39;Raisin&#39; in them.</span>
<span class="co"># these are the corresponding names:</span>
cerealnames[<span class="kw">grep</span>(<span class="st">&quot;Raisin&quot;</span>,cerealnames)]</code></pre>
<pre><code>##  [1] &quot;Crispy_Wheat_&amp;_Raisins&quot;           
##  [2] &quot;Muesli_Raisins,_Dates,_&amp;_Almonds&quot; 
##  [3] &quot;Muesli_Raisins,_Peaches,_&amp;_Pecans&quot;
##  [4] &quot;Nutri-Grain_Almond-Raisin&quot;        
##  [5] &quot;Oatmeal_Raisin_Crisp&quot;             
##  [6] &quot;Post_Nat._Raisin_Bran&quot;            
##  [7] &quot;Raisin_Bran&quot;                      
##  [8] &quot;Raisin_Nut_Bran&quot;                  
##  [9] &quot;Raisin_Squares&quot;                   
## [10] &quot;Total_Raisin_Bran&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now find the cereals whose name starts with Raisin.</span>
<span class="co"># The ^ symbol is part of a &#39;regular expression&#39;, it indicates &#39;starts with&#39;:</span>
<span class="kw">grep</span>(<span class="st">&quot;^Raisin&quot;</span>,cerealnames)</code></pre>
<pre><code>## [1] 59 60 61</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Or end with &#39;Bran&#39;</span>
<span class="co"># The $ symbol is part of a &#39;regular expression&#39;, and indicates &#39;ends with&#39;:</span>
<span class="kw">grep</span>(<span class="st">&quot;Bran$&quot;</span>, cerealnames)</code></pre>
<pre><code>##  [1]  1  2  3 20 29 53 59 60 65 71</code></pre>
<p>As mentioned, <code>grep</code> can do a <em>lot</em> of different things, so don’t be alarmed if you find the help page <em>a bit overwhelming</em>. However, there are a few options worth knowing about. One very useful option is to turn off the case-sensitivity, for example:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">grep</span>(<span class="st">&quot;bran&quot;</span>, cerealnames, <span class="dt">ignore.case=</span><span class="ot">TRUE</span>)</code></pre>
<pre><code>##  [1]  1  2  3  4  9 10 20 29 53 59 60 65 71</code></pre>
<p>finds <code>Bran</code> and <code>bran</code> and <code>BRAN</code>.</p>
<p>Finally, using the above tools, let’s add a new variable to the <code>cereal</code> dataset that is <code>TRUE</code> when the name of the cereal ends in ‘Bran’, otherwise it is <code>FALSE</code>. For this example, the <code>grepl</code> function is more useful (because it returns TRUE and FALSE).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># grepl will return FALSE when Bran is not found, TRUE otherwise</span>
cereals<span class="op">$</span>BranOrNot &lt;-<span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;Bran$&quot;</span>, cerealnames)

<span class="co"># Quick summary:</span>
<span class="kw">table</span>(cereals<span class="op">$</span>BranOrNot)</code></pre>
<pre><code>## 
## FALSE  TRUE 
##    67    10</code></pre>

<div class="rmdreading">
A clear explanation of regular expressions is on the Wikipedia page <a href="http://en.wikipedia.org/wiki/Regular_expressions" class="uri">http://en.wikipedia.org/wiki/Regular_expressions</a>. Also worth a look is Robin Lovelace’s introduction specifically for R and RStudio at <a href="https://www.r-bloggers.com/regular-expressions-in-r-vs-rstudio/" class="uri">https://www.r-bloggers.com/regular-expressions-in-r-vs-rstudio/</a>.
</div>

</div>
<div id="more-control-with-the-stringr-package" class="section level4">
<h4><span class="header-section-number">3.7.4.3</span> More control with the <code>stringr</code> package</h4>
<p>In the previous section we used <code>grep</code> and <code>grepl</code> to find text in strings, which we can use to subset dataframes, or simply to find data. We can do a lot more with strings, but things get a bit difficult quickly when we stick to base R. Instead, the <code>stringr</code> package provides an easy-to-use interface to many common text operations. The following examples give a few very handy tips, but the package provides much more (see <code>library(help=stringr)</code>).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)

<span class="co"># Extract all numbers from a string</span>
<span class="co"># Note that the result is a character!</span>
<span class="kw">str_extract</span>(<span class="st">&quot;I have 5 apples&quot;</span>, <span class="st">&quot;[0-9]&quot;</span>)</code></pre>
<pre><code>## [1] &quot;5&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract the nth word from text.</span>
<span class="kw">word</span>(<span class="st">&quot;Dantchoff, Mr Khristo&quot;</span>, <span class="dv">2</span>)</code></pre>
<pre><code>## [1] &quot;Mr&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Replace text that matches a pattern.</span>
<span class="co"># (sub or gsub from base R also work OK)</span>
<span class="kw">str_replace</span>(<span class="st">&quot;Dantchoff, Mr Khristo&quot;</span>, <span class="st">&quot;Mr&quot;</span>, <span class="st">&quot;Mrs&quot;</span>)</code></pre>
<pre><code>## [1] &quot;Dantchoff, Mrs Khristo&quot;</code></pre>
</div>
<div id="combining-text-and-r-objects-with-glue" class="section level4">
<h4><span class="header-section-number">3.7.4.4</span> Combining text and R objects with <code>glue</code></h4>
<p>When controlling output, we often want to combine results stored in R objects, and text. As we saw in Section <a href="summarize.html#paste">3.7.4.1</a>, we can use <code>paste</code> to achieve this, but there’s a better way:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(glue)

<span class="kw">data</span>(titanic)
<span class="kw">glue</span>(<span class="st">&quot;The titanic dataset has {nrow(titanic)} rows. &quot;</span>,
     <span class="st">&quot;For {percmissing}% of the data, Age is missing.&quot;</span>,
     <span class="dt">percmissing =</span> <span class="kw">round</span>(<span class="dv">100</span> <span class="op">*</span><span class="st"> </span><span class="kw">mean</span>(<span class="kw">is.na</span>(titanic<span class="op">$</span>Age)), <span class="dv">1</span>))</code></pre>
<pre><code>## The titanic dataset has 1313 rows. For 42.4% of the data, Age is missing.</code></pre>
<p>With <code>glue</code>, we can include both R code directly within <code>{}</code> (as we did with <code>nrow(titanic)</code>), and also use temporary variables (here: <code>percmissing</code>) that are given as extra arguments. Also note that strings separated by <code>,</code> are pasted together by <code>glue</code>.</p>
</div>
</div>
<div id="workingwithdates" class="section level3">
<h3><span class="header-section-number">3.7.5</span> Working with dates and times</h3>
<p>Admittedly, working with dates and times in R is somewhat annoying at first. The built-in help files on this subject describe all aspects of this special data type, but do not offer much for the beginning R user. This section covers basic operations that you may need when analysing and formatting datasets.</p>
<p>For working with dates, we use the <code>lubridate</code> package, which simplifies it tremendously.</p>
<div id="readingdates" class="section level4">
<h4><span class="header-section-number">3.7.5.1</span> Reading dates</h4>
<p>The built-in <code>Date</code> class in R is encoded as an integer number representing the number of days since 1-1-1970 (but this actual origin does not matter for the user). Converting a character string to a date with <code>as.Date</code> is straightforward if you use the standard order of dates: <code>YYYY-MM-DD</code>. So, for example,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.Date</span>(<span class="st">&quot;2008-5-22&quot;</span>)</code></pre>
<pre><code>## [1] &quot;2008-05-22&quot;</code></pre>
<p>The output here is not interesting, R simply prints the date. Because dates are represented as numbers in R, we can do basic arithmetic:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First load lubridate when working with dates or date-time combinations.</span>
<span class="co"># (as.Date and difftime are part of the base package, but lubridate provides</span>
<span class="co"># years(), months(), and many more functions used below).</span>
<span class="kw">library</span>(lubridate)

<span class="co"># A date, 7 days later:</span>
<span class="kw">as.Date</span>(<span class="st">&quot;2011-5-12&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="dv">7</span></code></pre>
<pre><code>## [1] &quot;2011-05-19&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Difference between dates.</span>
<span class="kw">as.Date</span>(<span class="st">&quot;2009-7-1&quot;</span>) <span class="op">-</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2008-12-1&quot;</span>)</code></pre>
<pre><code>## Time difference of 212 days</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># With difftime, you can specify the units:</span>
<span class="kw">difftime</span>(<span class="kw">as.Date</span>(<span class="st">&quot;2009-7-1&quot;</span>), <span class="kw">as.Date</span>(<span class="st">&quot;2008-12-1&quot;</span>), <span class="dt">units =</span> <span class="st">&quot;weeks&quot;</span>)</code></pre>
<pre><code>## Time difference of 30.28571 weeks</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># To add other timespans, use functions months(), years() or weeks() to</span>
<span class="co"># avoid problems with leap years</span>
<span class="kw">as.Date</span>(<span class="st">&quot;2013-8-18&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">years</span>(<span class="dv">10</span>) <span class="op">+</span><span class="st"> </span><span class="kw">months</span>(<span class="dv">1</span>)</code></pre>
<pre><code>## [1] &quot;2023-09-18&quot;</code></pre>

<div class="rmdtry">
The previous example showed a very useful trick for adding numbers to a <code>Date</code> to get a new <code>Date</code> a few days later. Confirm for yourself that this method accounts for leap years. That is, the day before <code>2011-3-1</code> should be <code>2011-2-28</code> (2011 is not a leap year). But what about <code>2012-3-1</code>?
</div>

<p>Often, text strings representing the date are not in the standard format. Fortunately, it is possible to convert any reasonable sequence to a <code>Date</code> object in R. All we have to do is provide a character string to <code>as.Date</code> and tell the function the order of the fields.</p>
<p>To convert any format to a Date, we can use the <code>lubridate</code> package, which contains the functions <code>ymd</code>, <code>mdy</code>, and all other combinations of y, m, and d. These functions are pretty smart, as can be seen in these examples:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Day / month / year</span>
<span class="kw">as.Date</span>(<span class="kw">dmy</span>(<span class="st">&quot;31/12/1991&quot;</span>))</code></pre>
<pre><code>## [1] &quot;1991-12-31&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Month - day - year (note, only two digits for the year)</span>
<span class="kw">as.Date</span>(<span class="kw">mdy</span>(<span class="st">&quot;4-17-92&quot;</span>))</code></pre>
<pre><code>## [1] &quot;1992-04-17&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Year month day</span>
<span class="kw">as.Date</span>(<span class="kw">ymd</span>(<span class="st">&quot;1976-5-22&quot;</span>))</code></pre>
<pre><code>## [1] &quot;1976-05-22&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#-- Unusual formatting can be read in with the &#39;format&#39; argument</span>
<span class="co"># in as.Date. See ?strptime for a list of codes.</span>
<span class="co"># For example, Year and day of year (&quot;%j&quot; stands for &#39;Julian date&#39;)</span>
<span class="kw">as.Date</span>(<span class="st">&quot;2011 121&quot;</span>, <span class="dt">format=</span><span class="st">&quot;%Y %j&quot;</span>)</code></pre>
<pre><code>## [1] &quot;2011-05-01&quot;</code></pre>
<p>Another method to construct date objects is when you do not have a character string as in the above example, but separate numeric variables for year, month and day. In this case, use the <code>ISOdate</code> function:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.Date</span>(<span class="kw">ISOdate</span>(<span class="dv">2008</span>,<span class="dv">12</span>,<span class="dv">2</span>))</code></pre>
<pre><code>## [1] &quot;2008-12-02&quot;</code></pre>
<p>Finally, here is a simple way to find the number of days since you were born, using <code>today</code> from the lubridate package.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Today&#39;s date (and time) can be with the today() function</span>
<span class="kw">today</span>()</code></pre>
<pre><code>## [1] &quot;2019-06-10&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We can now simply subtract your birthday from today&#39;s date.</span>
<span class="kw">today</span>() <span class="op">-</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;1976-5-22&quot;</span>)</code></pre>
<pre><code>## Time difference of 15724 days</code></pre>
</div>
<div id="example-using-dates-in-a-dataframe" class="section level4">
<h4><span class="header-section-number">3.7.5.2</span> Example: using dates in a dataframe</h4>
<p>The <code>as.Date</code> function that we met in the previous section also works with vectors of dates, and the <code>Date</code> class can also be part of a dataframe. Let’s take a look at the Hydro data to practice working with dates.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load the hydro dataset</span>
<span class="kw">data</span>(hydro)

<span class="co"># Now convert this to a Date variable. </span>
<span class="co"># If you first inspect head(hydro$Date), you will see the format is DD/MM/YYYY</span>
hydro<span class="op">$</span>Date &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">dmy</span>(hydro<span class="op">$</span>Date))</code></pre>
<p>If any of the date conversions go wrong, the <code>dmy</code> function (or its equivalents) should print a message letting you know. You can double check if <code>any</code> of the converted dates is <code>NA</code> like this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">any</span>(<span class="kw">is.na</span>(hydro<span class="op">$</span>Date))</code></pre>
<pre><code>## [1] FALSE</code></pre>
<p>We now have successfully read in the date variable. The <code>min</code> and <code>max</code> functions are useful to check the range of dates in the dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Minimum and maximum date (that is, oldest and most recent),</span>
<span class="kw">min</span>(hydro<span class="op">$</span>Date)</code></pre>
<pre><code>## [1] &quot;2005-08-08&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">max</span>(hydro<span class="op">$</span>Date)</code></pre>
<pre><code>## [1] &quot;2011-08-08&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#... and length of measurement period:</span>
<span class="kw">max</span>(hydro<span class="op">$</span>Date) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(hydro<span class="op">$</span>Date)</code></pre>
<pre><code>## Time difference of 2191 days</code></pre>
<p>Finally, the <code>Date</code> class is very handy when plotting. Let’s make a simple graph of the Hydro dataset. The following code produces Fig. <a href="summarize.html#fig:hydroplot">3.1</a>. Note how the <code>X</code> axis is automatically formatted to display the date in a (fairly) pretty way.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(hydro, <span class="kw">aes</span>(<span class="dt">x =</span> Date, <span class="dt">y =</span> storage)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre>
<div class="figure"><span id="fig:hydroplot"></span>
<img src="02-dataskills_files/figure-html/hydroplot-1.pdf" alt="A simple plot of the hydro data." width="672" />
<p class="caption">
Figure 3.1: A simple plot of the hydro data.
</p>
</div>
</div>
<div id="datetime" class="section level4">
<h4><span class="header-section-number">3.7.5.3</span> Date-Time combinations</h4>
<p>For dates that include the time, R has a special class called <code>POSIXct</code>. The <code>lubridate</code> package makes it easy to work with this class.</p>
<p>Internally, a date-time is represented as the number of seconds since the 1st of January, 1970. Time zones are also supported, but we will not use this functionality in this book (as it can be quite confusing).</p>
<p>From the lubridate package, we can use any combination of (y)ear,(m)onth,(d)ay, (h)our, (m)inutes, (s)econds. For example <code>ymd_hms</code> converts a character string in that order.</p>
<p>Let’s look at some examples,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load lubridate</span>
<span class="kw">library</span>(lubridate)

<span class="co"># The standard format is YYYY-MM-DD HH:MM:SS</span>
<span class="kw">ymd_hms</span>(<span class="st">&quot;2012-9-16 13:05:00&quot;</span>)</code></pre>
<pre><code>## [1] &quot;2012-09-16 13:05:00 UTC&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read two times (note the first has no seconds, so we can use ymd_hm)</span>
time1 &lt;-<span class="st"> </span><span class="kw">ymd_hm</span>(<span class="st">&quot;2008-5-21 9:05&quot;</span>)
time2 &lt;-<span class="st"> </span><span class="kw">ymd_hms</span>(<span class="st">&quot;2012-9-16 13:05:00&quot;</span>)

<span class="co"># Time difference:</span>
time2 <span class="op">-</span><span class="st"> </span>time1</code></pre>
<pre><code>## Time difference of 1579.167 days</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># And an example with a different format, DD/M/YY H:MM</span>
<span class="kw">dmy_hm</span>(<span class="st">&quot;23-1-89 4:30&quot;</span>)</code></pre>
<pre><code>## [1] &quot;1989-01-23 04:30:00 UTC&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># To convert a date-time to a Date, you can also use the as.Date function,</span>
<span class="co"># which will simply drop the time.</span>
<span class="kw">as.Date</span>(time1)</code></pre>
<pre><code>## [1] &quot;2008-05-21&quot;</code></pre>
<p>As with <code>Date</code> objects, we can calculate timespans using a few handy functions.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># What time is it 3 hours and 15 minutes from now?</span>
<span class="kw">now</span>() <span class="op">+</span><span class="st"> </span><span class="kw">hours</span>(<span class="dv">3</span>) <span class="op">+</span><span class="st"> </span><span class="kw">minutes</span>(<span class="dv">15</span>)</code></pre>
<pre><code>## [1] &quot;2019-06-10 13:02:19 CEST&quot;</code></pre>

<div class="rmdtry">
The 2012 Sydney marathon started at 7:20AM on September 16th. The winner completed the race in 2 hours, 11 minutes and 50 seconds. What was the time when the racer crossed the finish line? Using the <code>weekdays</code> function, which day was the race held?
</div>

</div>
<div id="example-date-times-in-a-dataframe" class="section level4">
<h4><span class="header-section-number">3.7.5.4</span> Example: date-times in a dataframe</h4>
<p>Now let’s use a real dataset to practice the use of date-times. We also introduce the functions <code>month</code>, <code>yday</code>, <code>hour</code> and <code>minute</code> to conveniently extract components of date-time objects.</p>
<p>The last command produces Fig. <a href="summarize.html#fig:hfemetdate">3.2</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read the 2008 met dataset from the HFE.</span>
<span class="kw">data</span>(hfemet2008)

<span class="co"># Convert &#39;DateTime&#39; to POSIXct class.</span>
<span class="co"># The order of the original data is MM/DD/YYYY HH:MM</span>
<span class="co"># We also add various date and time fields to the dataframe.</span>
hfemet &lt;-<span class="st"> </span>hfemet2008 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">DateTime =</span> <span class="kw">mdy_hm</span>(DateTime),
         <span class="dt">Date =</span> <span class="kw">as.Date</span>(DateTime),
         <span class="dt">DOY =</span> <span class="kw">yday</span>(DateTime),
         <span class="dt">hour =</span> <span class="kw">hour</span>(DateTime),
         <span class="dt">minute =</span> <span class="kw">minute</span>(DateTime),
         <span class="dt">month =</span> <span class="kw">month</span>(DateTime))

<span class="co"># Make sure all datetimes were converted OK (if not, NAs would be produced)</span>
<span class="kw">any</span>(<span class="kw">is.na</span>(hfemet<span class="op">$</span>DateTime))</code></pre>
<pre><code>## [1] FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># FALSE is good here!</span>

<span class="co"># Make a simple line plot for data from one month.</span>
<span class="kw">filter</span>(hfemet, month <span class="op">==</span><span class="st">  </span><span class="dv">6</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> DateTime, <span class="dt">y =</span>  Tair)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre>
<div class="figure"><span id="fig:hfemetdate"></span>
<img src="02-dataskills_files/figure-html/hfemetdate-1.pdf" alt="Air temperature for June at the HFE" width="672" />
<p class="caption">
Figure 3.2: Air temperature for June at the HFE
</p>
</div>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># We can also take a subset of just one day, using the Date variable we added:</span>
hfemet_oneday &lt;-<span class="st"> </span><span class="kw">filter</span>(hfemet, Date <span class="op">==</span><span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2008-11-1&quot;</span>))</code></pre>
</div>
<div id="seqdates" class="section level4">
<h4><span class="header-section-number">3.7.5.5</span> Sequences of dates and times</h4>
<p>It is often useful to generate sequences of dates. We can use <code>seq</code> as we do for numeric variables (as we already saw in Section <a href="summarize.html#sequences">3.2.1</a>).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A series of dates, by day:</span>
<span class="kw">seq</span>(<span class="dt">from=</span><span class="kw">as.Date</span>(<span class="st">&quot;2011-1-1&quot;</span>), <span class="dt">to=</span><span class="kw">as.Date</span>(<span class="st">&quot;2011-1-5&quot;</span>), <span class="dt">by=</span><span class="st">&quot;day&quot;</span>)</code></pre>
<pre><code>## [1] &quot;2011-01-01&quot; &quot;2011-01-02&quot; &quot;2011-01-03&quot; &quot;2011-01-04&quot; &quot;2011-01-05&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Two-weekly dates:</span>
<span class="kw">seq</span>(<span class="dt">from=</span><span class="kw">as.Date</span>(<span class="st">&quot;2011-1-1&quot;</span>), <span class="dt">length=</span><span class="dv">4</span>, <span class="dt">by=</span><span class="st">&quot;2 weeks&quot;</span>)</code></pre>
<pre><code>## [1] &quot;2011-01-01&quot; &quot;2011-01-15&quot; &quot;2011-01-29&quot; &quot;2011-02-12&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Monthly:</span>
<span class="kw">seq</span>(<span class="dt">from=</span><span class="kw">as.Date</span>(<span class="st">&quot;2011-12-13&quot;</span>), <span class="dt">length=</span><span class="dv">4</span>, <span class="dt">by=</span><span class="st">&quot;months&quot;</span>)</code></pre>
<pre><code>## [1] &quot;2011-12-13&quot; &quot;2012-01-13&quot; &quot;2012-02-13&quot; &quot;2012-03-13&quot;</code></pre>
<p>Similarly, you can generate sequences of date-times.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Generate a sequence with 30 min timestep:</span>
<span class="co"># Here, the &#39;by&#39; field specifies the timestep in seconds.</span>
fromtime &lt;-<span class="st"> </span><span class="kw">ymd_hm</span>(<span class="st">&quot;2012-6-1 14:30&quot;</span>)
<span class="kw">seq</span>(<span class="dt">from=</span>fromtime, <span class="dt">length=</span><span class="dv">3</span>, <span class="dt">by=</span><span class="dv">30</span><span class="op">*</span><span class="dv">60</span>)</code></pre>
<pre><code>## [1] &quot;2012-06-01 14:30:00 UTC&quot; &quot;2012-06-01 15:00:00 UTC&quot;
## [3] &quot;2012-06-01 15:30:00 UTC&quot;</code></pre>
</div>
</div>
<div id="converttype" class="section level3">
<h3><span class="header-section-number">3.7.6</span> Converting between data types</h3>
<p>It is often useful, or even necessary, to convert from one data type to another. For example, when you read in data with <code>read.csv</code> or <code>read.table</code>, any column that contains some non-numeric values (that is, values that cannot be converted to a number) will be converted to a factor variable. Sometimes you actually want to convert it to numeric, which will result in some missing values (<code>NA</code>) when the value could not be converted to a number.</p>
<p>Another common example is when one of your variables should be read in as a factor variable (for example, a column with treatment codes), but because all the values are numeric, R will simply assume it is a numeric column.</p>
<p>Before we learn how to convert, it is useful to make sure you know what type of data you have to begin with. To find out what type of data a particular vector is, we use <code>str</code> (this is also useful for any other object in R).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Numeric</span>
y &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">100</span>,<span class="dv">10</span>)
<span class="kw">str</span>(y)</code></pre>
<pre><code>##  num [1:3] 1 100 10</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This example also shows the dimension of the vector ([1:3]).</span>

<span class="co"># Character</span>
x &lt;-<span class="st"> &quot;sometext&quot;</span>
<span class="kw">str</span>(x)</code></pre>
<pre><code>##  chr &quot;sometext&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Factor</span>
p &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">c</span>(<span class="st">&quot;apple&quot;</span>,<span class="st">&quot;banana&quot;</span>))
<span class="kw">str</span>(p)</code></pre>
<pre><code>##  Factor w/ 2 levels &quot;apple&quot;,&quot;banana&quot;: 1 2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Logical</span>
z &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">FALSE</span>)
<span class="kw">str</span>(z)</code></pre>
<pre><code>##  logi [1:2] TRUE FALSE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Date</span>
sometime &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;1979-9-16&quot;</span>)
<span class="kw">str</span>(sometime)</code></pre>
<pre><code>##  Date[1:1], format: &quot;1979-09-16&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Date-Time</span>
<span class="kw">library</span>(lubridate)
onceupon &lt;-<span class="st"> </span><span class="kw">ymd_hm</span>(<span class="st">&quot;1969-8-18 09:00&quot;</span>)
<span class="kw">str</span>(onceupon)</code></pre>
<pre><code>##  POSIXct[1:1], format: &quot;1969-08-18 09:00:00&quot;</code></pre>
<p>To test for a particular type of data, use the <code>is.*something*</code> functions,
which give <code>TRUE</code> if the object is of that type, for example:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Test for numeric data type:</span>
<span class="kw">is.numeric</span>(<span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">189</span>))</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Test for character:</span>
<span class="kw">is.character</span>(<span class="st">&quot;HIE&quot;</span>)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>We can convert between types with the <code>as.*something*</code> class of functions.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># First we make six example values that we will use to convert</span>
mynum &lt;-<span class="st"> </span><span class="dv">1001</span>
mychar &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;1001&quot;</span>,<span class="st">&quot;100 apples&quot;</span>)
myfac &lt;-<span class="st"> </span><span class="kw">factor</span>(<span class="kw">c</span>(<span class="st">&quot;280&quot;</span>,<span class="st">&quot;400&quot;</span>,<span class="st">&quot;650&quot;</span>))
mylog &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">TRUE</span>,<span class="ot">FALSE</span>,<span class="ot">FALSE</span>,<span class="ot">TRUE</span>)
mydate &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="st">&quot;2015-03-18&quot;</span>)
mydatetime &lt;-<span class="st"> </span><span class="kw">ymd_hm</span>(<span class="st">&quot;2011-8-11 16:00&quot;</span>)

<span class="co"># A few examples:</span>

<span class="co"># Convert to character</span>
<span class="kw">as.character</span>(mynum)</code></pre>
<pre><code>## [1] &quot;1001&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">as.character</span>(myfac)</code></pre>
<pre><code>## [1] &quot;280&quot; &quot;400&quot; &quot;650&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Convert to numeric</span>
<span class="co"># Note that one missing value is created</span>
<span class="kw">as.numeric</span>(mychar)</code></pre>
<pre><code>## Warning: NAs introduced by coercion</code></pre>
<pre><code>## [1] 1001   NA</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Warning!!!</span>
<span class="co"># When converting from a factor to numeric, first convert to character</span>
<span class="co"># !!!</span>
<span class="kw">as.numeric</span>(<span class="kw">as.character</span>(myfac))</code></pre>
<pre><code>## [1] 280 400 650</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Convert to Date</span>
<span class="kw">as.Date</span>(mydatetime)</code></pre>
<pre><code>## [1] &quot;2011-08-11&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Convert to factor</span>
<span class="kw">as.factor</span>(mylog)</code></pre>
<pre><code>## [1] TRUE  FALSE FALSE TRUE 
## Levels: FALSE TRUE</code></pre>

<div class="rmdcaution">
When converting a factor to numeric (i.e. when the factor labels can be converted to numeric values), first convert it to character: <code>x &lt;- as.numeric(as.character(somefactor))</code>. The reason for this is that factor variables are internally stored as integer numbers, referring to the <em>levels</em> of the factor.
</div>

</div>
</div>
<div id="summarizing-dataframes" class="section level2">
<h2><span class="header-section-number">3.8</span> Summarizing dataframes</h2>
<p>There are a few useful functions to print general summaries of a dataframe, to see which variables are included, what types of data they contain, and so on. We already looked at <code>summary</code> and <code>str</code> in Section <a href="summarize.html#dataframes">3.4</a>.</p>
<p>Two more very useful functions are from the <code>Hmisc</code> package. The first, <code>describe</code>, is much like <code>summary</code>, but offers slightly more sophisticated statistics. The second, <code>contents</code>, is similar to <code>str</code>, but does a very nice job of summarizing the <code>factor</code> variables in your dataframe, prints the number of missing variables, the number of rows, and so on.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load data</span>
<span class="kw">data</span>(pupae)

<span class="co"># Make sure CO2_treatment is a factor (it will be read as a number)</span>
pupae<span class="op">$</span>CO2_treatment &lt;-<span class="st"> </span><span class="kw">as.factor</span>(pupae<span class="op">$</span>CO2_treatment)

<span class="co"># Show contents:</span>
<span class="kw">library</span>(Hmisc)  
<span class="kw">contents</span>(pupae)</code></pre>
<pre><code>## 
## Data frame:pupae 84 observations and 5 variables    Maximum # NAs:6
## 
## 
##               Levels Storage NAs
## T_treatment        2 integer   0
## CO2_treatment      2 integer   0
## Gender               integer   6
## PupalWeight           double   0
## Frass                 double   1
## 
## +-------------+----------------+
## |Variable     |Levels          |
## +-------------+----------------+
## |T_treatment  |ambient,elevated|
## +-------------+----------------+
## |CO2_treatment|280,400         |
## +-------------+----------------+</code></pre>
<p>Here, <code>storage</code> refers to the internal storage type of the variable: note that the factor variables are stored as ‘integer’, and other numbers as ‘double’ (this refers to the precision of the number).</p>
<div id="tapplyaggregate" class="section level3">
<h3><span class="header-section-number">3.8.1</span> Making summary tables</h3>
<div id="tapply" class="section level4">
<h4><span class="header-section-number">3.8.1.1</span> Summarizing vectors with <code>tapply</code></h4>
<p>If we have the following dataset called <code>plantdat</code>,</p>
<p><img src="screenshots/exampledata.png" width="33%" /></p>
<p>and execute the command</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">with</span>(plantdat, <span class="kw">tapply</span>(Plantbiomass, Treatment, mean))</code></pre>
<p>we get the result</p>
<p><img src="screenshots/tapplyresult.png" width="33%" /></p>
<p>Note that the result is a <code>vector</code> (elements of a vector can have names, like columns of a dataframe).</p>
<p>If we have the following dataset called <code>plantdat2</code>,</p>
<p><img src="screenshots/exampledatalarger.png" width="33%" /></p>
<p>and execute the command</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">with</span>(plantdat2, <span class="kw">tapply</span>(Plantbiomass, <span class="kw">list</span>(Species, Treatment), mean))</code></pre>
<p>we get the result</p>
<p><img src="screenshots/tapplyresultlarger.png" width="33%" /></p>
<p>Note that the result here is a <code>matrix</code>, where <code>A</code> and <code>B</code>, the species codes, are the rownames of this matrix.</p>
<p>Often, you want to summarize a variable by the levels of another variable. For example, in the <code>rain</code> data, the <code>Rain</code> variable gives daily values, but we might want to calculate annual sums,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read data</span>
<span class="kw">data</span>(rain)

<span class="co"># Annual rain totals.</span>
<span class="kw">with</span>(rain, <span class="kw">tapply</span>(Rain, Year, <span class="dt">FUN=</span>sum))</code></pre>
<pre><code>##   1996   1997   1998   1999   2000   2001   2002   2003   2004   2005 
##  717.2  640.4  905.4 1021.3  693.5  791.5  645.9  691.8  709.5  678.2</code></pre>
<p>The <code>tapply</code> function applies a function (<code>sum</code>) to a vector (<code>Rain</code>), that is split into chunks depending on another variable (<code>Year</code>).</p>
<p>We can also use the <code>tapply</code> function on more than one variable at a time. Consider these examples on the <code>pupae</code> data.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Average pupal weight by CO2 and T treatment:</span>
<span class="kw">with</span>(pupae, <span class="kw">tapply</span>(PupalWeight, <span class="kw">list</span>(CO2_treatment, T_treatment), <span class="dt">FUN=</span>mean))</code></pre>
<pre><code>##       ambient elevated
## 280 0.2900000  0.30492
## 400 0.3419565  0.29900</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Further split the averages, by gender of the pupae.</span>
<span class="kw">with</span>(pupae, <span class="kw">tapply</span>(PupalWeight, <span class="kw">list</span>(CO2_treatment, T_treatment, Gender), <span class="dt">FUN=</span>mean))</code></pre>
<pre><code>## , , 0
## 
##      ambient  elevated
## 280 0.251625 0.2700000
## 400 0.304000 0.2687143
## 
## , , 1
## 
##       ambient  elevated
## 280 0.3406000 0.3386364
## 400 0.3568333 0.3692857</code></pre>
<p>As the examples show, the <code>tapply</code> function produces summary tables by one or more factors. The resulting object is either a vector (when using one factor), or a matrix (as in the examples using the pupae data).</p>
<p>The limitations of <code>tapply</code> are that you can only summarize one variable at a time, and that the result is not a dataframe.</p>
<p>The main advantage of <code>tapply</code> is that we can use it as input to <code>barplot</code>, as the following example demonstrates (Fig. fig:pupgroupedbar})</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Pupal weight by CO2 and Gender. Result is a matrix.</span>
pupm &lt;-<span class="st"> </span><span class="kw">with</span>(pupae, <span class="kw">tapply</span>(PupalWeight, <span class="kw">list</span>(CO2_treatment,Gender), 
                           mean, <span class="dt">na.rm=</span><span class="ot">TRUE</span>))

<span class="co"># When barplot is provided a matrix, it makes a grouped barplot.</span>
<span class="co"># We specify xlim to make some room for the legend.</span>
<span class="kw">barplot</span>(pupm, <span class="dt">beside=</span><span class="ot">TRUE</span>, <span class="dt">legend.text=</span><span class="ot">TRUE</span>, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">8</span>),
        <span class="dt">xlab=</span><span class="st">&quot;Gender&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Pupal weight&quot;</span>)</code></pre>
<div class="figure"><span id="fig:pupgroupedbar"></span>
<img src="02-dataskills_files/figure-html/pupgroupedbar-1.pdf" alt="A grouped barplot of average pupal weight by CO2 and Gender for the pupae dataset. This is easily achieved via the use of tapply." width="672" />
<p class="caption">
Figure 3.3: A grouped barplot of average pupal weight by CO2 and Gender for the pupae dataset. This is easily achieved via the use of tapply.
</p>
</div>
</div>
<div id="summaryby" class="section level4">
<h4><span class="header-section-number">3.8.1.2</span> Quick summary tables with <code>summaryBy</code></h4>
<p>If we have the following dataset called <code>plantdat</code>,</p>
<p><img src="screenshots/exampledata.png" width="33%" /></p>
<p>and execute the command</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(doBy)
<span class="kw">summaryBy</span>(Plantbiomass <span class="op">~</span><span class="st"> </span>treatment, <span class="dt">FUN=</span>mean, <span class="dt">data=</span>plantdat)</code></pre>
<p>we get the result</p>
<p><img src="screenshots/summarybyresult.png" width="33%" /></p>
<p>Note that the result here is a <code>dataframe</code>.</p>
<p>If we have the following dataset called <code>plantdat2</code>,</p>
<p><img src="screenshots/exampledatalarger.png" width="33%" /></p>
<p>and execute the command</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summaryBy</span>(Plantbiomass <span class="op">~</span><span class="st"> </span>Species <span class="op">+</span><span class="st"> </span>Treatment, <span class="dt">FUN=</span>mean, <span class="dt">data=</span>dfr)</code></pre>
<p>we get the result</p>
<p><img src="screenshots/summarybyresultlarger.png" width="33%" /></p>
<p>Note that the result here is a <code>dataframe</code>.</p>
<p>In practice, it is often useful to make summary tables of multiple variables at once, and to end up with a dataframe. In this book we first use <code>summaryBy</code>, from the <code>doBy</code> package, to achieve this.</p>
<p>With <code>summaryBy</code>, we can generate multiple summaries (mean, standard deviation, etc.) on more than one variable in a dataframe at once. We can use a convenient formula interface for this. It is of the form,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summaryBy</span>(Yvar1 <span class="op">+</span><span class="st"> </span>Yvar2 <span class="op">~</span><span class="st"> </span>Groupvar1 <span class="op">+</span><span class="st"> </span>Groupvar2, <span class="dt">FUN=</span><span class="kw">c</span>(mean,sd), <span class="dt">data=</span>mydata)</code></pre>
<p>where we summarize the (numeric) variables <code>Yvar1</code> and <code>Yvar2</code> by all combinations of the (factor) variables <code>Groupvar1</code> and <code>Groupvar2</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load the doBy package</span>
<span class="kw">library</span>(doBy)

<span class="co"># read pupae data if you have not already</span>
<span class="kw">data</span>(pupae)

<span class="co"># Get mean and standard deviation of Frass by CO2 and T treatments</span>
<span class="kw">summaryBy</span>(Frass <span class="op">~</span><span class="st"> </span>CO2_treatment <span class="op">+</span><span class="st"> </span>T_treatment,
          <span class="dt">data=</span>pupae, <span class="dt">FUN=</span><span class="kw">c</span>(mean,sd))</code></pre>
<pre><code>##   CO2_treatment T_treatment Frass.mean  Frass.sd
## 1           280     ambient         NA        NA
## 2           280    elevated   1.479520 0.2387150
## 3           400     ambient   2.121783 0.4145402
## 4           400    elevated   1.912045 0.3597471</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Note that there is a missing value. We can specify na.rm=TRUE,</span>
<span class="co"># which will be passed to both mean() and sd(). It works because those</span>
<span class="co"># functions recognize that argument (i.e. na.rm is NOT an argument of </span>
<span class="co"># summaryBy itself!)</span>
<span class="kw">summaryBy</span>(Frass <span class="op">~</span><span class="st"> </span>CO2_treatment <span class="op">+</span><span class="st"> </span>T_treatment,
          <span class="dt">data=</span>pupae, <span class="dt">FUN=</span><span class="kw">c</span>(mean,sd), <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</code></pre>
<pre><code>##   CO2_treatment T_treatment Frass.mean  Frass.sd
## 1           280     ambient   1.953923 0.4015635
## 2           280    elevated   1.479520 0.2387150
## 3           400     ambient   2.121783 0.4145402
## 4           400    elevated   1.912045 0.3597471</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># However, if we use a function that does not recognize it, we first have to</span>
<span class="co"># exclude all missing values before making a summary table, like this:</span>
pupae_nona &lt;-<span class="st"> </span>pupae[<span class="kw">complete.cases</span>(pupae),]

<span class="co"># Get mean and standard deviation for</span>
<span class="co"># the pupae data (Pupal weight and Frass), by CO2 and T treatment.</span>
<span class="co"># Note that length() does not recognize na.rm (see ?length), which is</span>
<span class="co"># why we have excluded any NA from pupae first.</span>
<span class="kw">summaryBy</span>(PupalWeight<span class="op">+</span>Frass <span class="op">~</span><span class="st"> </span>CO2_treatment <span class="op">+</span><span class="st"> </span>T_treatment,
          <span class="dt">data=</span>pupae_nona,
          <span class="dt">FUN=</span><span class="kw">c</span>(mean,sd,length))</code></pre>
<pre><code>##   CO2_treatment T_treatment PupalWeight.mean Frass.mean PupalWeight.sd
## 1           280     ambient        0.2912500   1.957333     0.04895847
## 2           280    elevated        0.3014583   1.473167     0.05921000
## 3           400     ambient        0.3357000   2.103250     0.05886479
## 4           400    elevated        0.3022381   1.931000     0.06602189
##    Frass.sd PupalWeight.length Frass.length
## 1 0.4192227                 12           12
## 2 0.2416805                 24           24
## 3 0.4186310                 20           20
## 4 0.3571969                 21           21</code></pre>
<p>You can also use any function that returns a vector of results. In the following example we calculate the 5% and 95% quantiles of all numeric variables in the allometry dataset. To do this, use <code>.</code> for the left-hand side of the formula.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># . ~ species means &#39;all numeric variables by species&#39;.</span>
<span class="co"># Extra arguments to the function used (in this case quantile) can be set here as well,</span>
<span class="co"># they will be passed to that function (see ?quantile).</span>
<span class="kw">summaryBy</span>(. <span class="op">~</span><span class="st"> </span>species, <span class="dt">data=</span>allometry, <span class="dt">FUN=</span>quantile, <span class="dt">probs=</span><span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))</code></pre>
<pre><code>##   species diameter.5% diameter.95% height.5% height.95% leafarea.5%
## 1    PIMO      8.1900      70.9150  5.373000     44.675    7.540916
## 2    PIPO     11.4555      69.1300  5.903499     39.192   10.040843
## 3    PSME      6.1635      56.5385  5.276000     32.602    4.988747
##   leafarea.95% branchmass.5% branchmass.95%
## 1     380.3984      4.283342       333.6408
## 2     250.1295      7.591966       655.1097
## 3     337.5367      3.515638       403.7902</code></pre>
</div>
<div id="dplyr" class="section level4">
<h4><span class="header-section-number">3.8.1.3</span> Summarizing dataframes with <code>dplyr</code></h4>
<p>We started with the <code>summaryBy</code> package, since it is so easy to use. A more modern and popular approach is to use <code>dplyr</code> for all your dataframe summarizing needs. The main advantage is that <code>dplyr</code> is very, very fast. For datasets with &gt; hundreds of thousands of rows, you will notice an incredible speed increase. For millions of rows, you really have to use <code>dplyr</code> (or <code>data.table</code>, but we don’t cover that package in this book).</p>
<p>Making summary tables as we did in the above examples requires two steps:</p>
<ol style="list-style-type: decimal">
<li>Group your dataframe by one or more factor variables</li>
<li>Apply summarizing functions to each of the groups</li>
</ol>
<p>As is the norm, we use the pipe operator (<code>%&gt;%</code>) to keep the steps apart. Here is a simple example to get started.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)

<span class="kw">group_by</span>(pupae, CO2_treatment, T_treatment) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">Frass_mean =</span> <span class="kw">mean</span>(Frass, <span class="dt">na.rm=</span><span class="ot">TRUE</span>),
            <span class="dt">Frass_sd =</span> <span class="kw">sd</span>(Frass, <span class="dt">na.rm=</span><span class="ot">TRUE</span>))</code></pre>
<pre><code>## # A tibble: 4 x 4
## # Groups:   CO2_treatment [2]
##   CO2_treatment T_treatment Frass_mean Frass_sd
##           &lt;int&gt; &lt;fct&gt;            &lt;dbl&gt;    &lt;dbl&gt;
## 1           280 ambient           1.95    0.402
## 2           280 elevated          1.48    0.239
## 3           400 ambient           2.12    0.415
## 4           400 elevated          1.91    0.360</code></pre>
<p>I used <code>as.data.frame</code> at the end, so we arrive at an actual dataframe, not a tibble (only for the reason so you can compare the output to the previous examples). The <code>dplyr</code> package (and others) always produce tibbles, which are really just dataframes but with some adjusted printing methods.</p>
<p>In <code>summarize</code> you can specify each of the new variables that should be produced, in this case giving mean and standard deviation of Frass. If we want to apply a number of functions over many variables, we can use <code>summarize_at</code>, like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">group_by</span>(pupae, CO2_treatment, T_treatment) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize_at</span>(<span class="dt">.vars =</span> <span class="kw">c</span>(<span class="st">&quot;Frass&quot;</span>, <span class="st">&quot;PupalWeight&quot;</span>),
                <span class="dt">.funs =</span> <span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;sd&quot;</span>))</code></pre>
<pre><code>## # A tibble: 4 x 6
## # Groups:   CO2_treatment [2]
##   CO2_treatment T_treatment Frass_mean PupalWeight_mean Frass_sd
##           &lt;int&gt; &lt;fct&gt;            &lt;dbl&gt;            &lt;dbl&gt;    &lt;dbl&gt;
## 1           280 ambient          NA               0.290  NaN    
## 2           280 elevated          1.48            0.305    0.239
## 3           400 ambient           2.12            0.342    0.415
## 4           400 elevated          1.91            0.299    0.360
## # ... with 1 more variable: PupalWeight_sd &lt;dbl&gt;</code></pre>
<p>The result is identical to our last example with <code>summaryBy</code>.</p>
<p>Let’s look at a more advanced example using weather data collected at the Hawkesbury Forest Experiment in 2008. The data given are in half-hourly time steps. It is a reasonable request to provide data as daily averages (for temperature) and daily sums (for precipitation).</p>
<p>The following code produces a daily weather dataset, and Fig. <a href="summarize.html#fig:hfemetaggregate">3.4</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read data, convert DateTime field to a proper Datetime class using</span>
<span class="co"># lubridate&#39;s mdy_hm function, and add a Date column with as.Date.</span>
<span class="co"># Instead of loading packages, we use :: in the example below to make sure</span>
<span class="co"># the functions are used from the right package.</span>
<span class="kw">data</span>(hfemet2008)

hfemet_agg &lt;-<span class="st"> </span>hfemet2008 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">DateTime =</span> lubridate<span class="op">::</span><span class="kw">mdy_hm</span>(DateTime),
         <span class="dt">Date =</span> <span class="kw">as.Date</span>(DateTime)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(Date) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">Rain =</span> <span class="kw">sum</span>(Rain),
            <span class="dt">Tair =</span> <span class="kw">mean</span>(Tair))

<span class="co"># A simple plot of daily rainfall.</span>
<span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(hfemet_agg, <span class="kw">aes</span>(<span class="dt">x =</span> Date, <span class="dt">y =</span> Rain)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>)</code></pre>
<div class="figure"><span id="fig:hfemetaggregate"></span>
<img src="02-dataskills_files/figure-html/hfemetaggregate-1.pdf" alt="Daily rainfall at the HFE in 2008" width="672" />
<p class="caption">
Figure 3.4: Daily rainfall at the HFE in 2008
</p>
</div>
</div>
<div id="using-padr-to-aggregate-timeseries-data" class="section level4">
<h4><span class="header-section-number">3.8.1.4</span> Using <code>padr</code> to aggregate timeseries data</h4>
<p>In the previous example we saw a quick and concise methods to aggregate and filter a dataframe that includes a single date-time column (here roughly referred to as timeseries data). In the example, we calculated daily totals and averages, but what if we want to aggregate by other timespans, like two-week intervals, 6 months, or 15 minutes? The <code>padr</code> package is very convenient for this sort of mutation.</p>
<p>The following example uses <code>padr</code> in combination with several functions from <code>dplyr</code> to make a table of total rainfall in 4 hour increments for one day, using the <code>hfemet2008</code> dataset.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(padr)
<span class="kw">library</span>(lubridate)

<span class="co"># From the lgrdata package</span>
<span class="kw">data</span>(hfemet2008)

<span class="kw">mutate</span>(hfemet2008, <span class="dt">DateTime =</span> <span class="kw">mdy_hm</span>(DateTime)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># convert to proper DateTime</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">as.Date</span>(DateTime) <span class="op">==</span><span class="st"> &quot;2008-6-3&quot;</span>) <span class="op">%&gt;%</span><span class="st">       </span><span class="co"># select a single day</span>
<span class="st">  </span><span class="kw">thicken</span>(<span class="st">&quot;4 hours&quot;</span>, <span class="dt">round=</span><span class="st">&quot;down&quot;</span>) <span class="op">%&gt;%</span><span class="st">              </span><span class="co"># add datetime in 4hour steps</span>
<span class="st">  </span><span class="kw">group_by</span>(DateTime_<span class="dv">4</span>_hour) <span class="op">%&gt;%</span><span class="st">                     </span><span class="co"># set grouping variable</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">Rain =</span> <span class="kw">sum</span>(Rain)) <span class="op">%&gt;%</span><span class="st">                   </span><span class="co"># sum over the grouping variable</span>
<span class="st">  </span><span class="kw">select</span>(<span class="dt">DateTime =</span> DateTime_<span class="dv">4</span>_hour, Rain)          <span class="co"># show two variables</span></code></pre>
<pre><code>## # A tibble: 6 x 2
##   DateTime             Rain
##   &lt;dttm&gt;              &lt;dbl&gt;
## 1 2008-06-03 00:00:00   2.4
## 2 2008-06-03 04:00:00   1.8
## 3 2008-06-03 08:00:00  11.8
## 4 2008-06-03 12:00:00   5.6
## 5 2008-06-03 16:00:00   6.6
## 6 2008-06-03 20:00:00  26.4</code></pre>
</div>
</div>
<div id="xtabs" class="section level3">
<h3><span class="header-section-number">3.8.2</span> Tables of counts</h3>
<p>It is often useful to count the number of observations by one or more multiple factors. One option is to use <code>tapply</code> or <code>summaryBy</code> in combination with the <code>length</code> function. A much better alternative is to use the <code>xtabs</code> and <code>ftable</code> functions, in addition to the simple use of <code>table</code>. Alternatively, <code>dplyr</code> provides a <code>count</code> function. We will look at both options.</p>
<p>Consider these examples using the Titanic data.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read titanic data</span>
<span class="kw">data</span>(titanic)

<span class="co"># Count observations by passenger class</span>
<span class="kw">table</span>(titanic<span class="op">$</span>PClass)</code></pre>
<pre><code>## 
## 1st 2nd 3rd 
## 322 280 711</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># With more grouping variables, it is more convenient to use xtabs.</span>
<span class="co"># Count observations by combinations of passenger class, sex, and whether they survived:</span>
<span class="kw">xtabs</span>( <span class="op">~</span><span class="st"> </span>PClass <span class="op">+</span><span class="st"> </span>Sex <span class="op">+</span><span class="st"> </span>Survived, <span class="dt">data=</span>titanic)</code></pre>
<pre><code>## , , Survived = 0
## 
##       Sex
## PClass female male
##    1st      9  120
##    2nd     13  148
##    3rd    132  441
## 
## , , Survived = 1
## 
##       Sex
## PClass female male
##    1st    134   59
##    2nd     94   25
##    3rd     80   58</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The previous output is hard to read, consider using ftable on the result:</span>
<span class="kw">ftable</span>(<span class="kw">xtabs</span>( <span class="op">~</span><span class="st"> </span>PClass <span class="op">+</span><span class="st"> </span>Sex <span class="op">+</span><span class="st"> </span>Survived, <span class="dt">data=</span>titanic))</code></pre>
<pre><code>##               Survived   0   1
## PClass Sex                    
## 1st    female            9 134
##        male            120  59
## 2nd    female           13  94
##        male            148  25
## 3rd    female          132  80
##        male            441  58</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Using dplyr, the result is a dataframe (actually, a tibble)</span>
<span class="kw">library</span>(dplyr)
titanic <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">count</span>(PClass, Sex, Survived)</code></pre>
<pre><code>## # A tibble: 12 x 4
##    PClass Sex    Survived     n
##    &lt;fct&gt;  &lt;fct&gt;     &lt;int&gt; &lt;int&gt;
##  1 1st    female        0     9
##  2 1st    female        1   134
##  3 1st    male          0   120
##  4 1st    male          1    59
##  5 2nd    female        0    13
##  6 2nd    female        1    94
##  7 2nd    male          0   148
##  8 2nd    male          1    25
##  9 3rd    female        0   132
## 10 3rd    female        1    80
## 11 3rd    male          0   441
## 12 3rd    male          1    58</code></pre>
</div>
<div id="summaryvars" class="section level3">
<h3><span class="header-section-number">3.8.3</span> Adding summary variables to dataframes</h3>
<p>We saw how <code>tapply</code> can make simple tables of averages (or totals, or other functions) of some variable by the levels of one or more factor variables. The result of <code>tapply</code> is typically a vector with a length equal to the number of levels of the factor you summarized by (see examples in Section <a href="summarize.html#tapply">3.8.1.1</a>).</p>
<p>Consider the <code>allometry</code> dataset, which includes tree height for three species. Suppose you want to add a new variable ‘MaxHeight’, that is the maximum tree height observed per species. We can use <code>ave</code> to achieve this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read data</span>
allom &lt;-<span class="st"> </span>allometry <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">MaxHeight =</span> <span class="kw">ave</span>(height, species, <span class="dt">FUN=</span>max))

<span class="co"># Look at first few rows (or just type allom to see whole dataset)</span>
<span class="kw">head</span>(allom)</code></pre>
<pre><code>##   species diameter height   leafarea branchmass treeSizeClass MaxHeight
## 1    PSME    54.61  27.04 338.485622  410.24638         large      33.3
## 2    PSME    34.80  27.42 122.157864   83.65030        medium      33.3
## 3    PSME    24.89  21.23   3.958274    3.51270         small      33.3
## 4    PSME    28.70  24.96  86.350653   73.13027        medium      33.3
## 5    PSME    34.80  29.99  63.350906   62.39044        medium      33.3
## 6    PSME    37.85  28.07  61.372765   53.86594        medium      33.3</code></pre>
<p>Note that you can use any function in place of <code>max</code>, as long as that function can take a vector as an argument, and returns a single number.</p>

<div class="rmdtry">
If you want results similar to <code>ave</code>, you can use <code>summaryBy</code> with the argument <code>full.dimension=TRUE</code>. Try <code>summaryBy</code> on the <code>pupae</code> dataset with that argument set, and compare the result to <code>full.dimension=FALSE</code>, which is the default.
</div>

</div>
<div id="reorder" class="section level3">
<h3><span class="header-section-number">3.8.4</span> Reordering factor levels based on a summary variable</h3>
<p>It is often useful to tabulate your data in a meaningful order. We saw that, when using <code>summaryBy</code>, <code>tapply</code> or similar functions, that the results are always in the order of your factor levels. Recall that the default order is alphabetical. This is rarely what you want.</p>
<p>You can reorder the factor levels by some summary variable. For example,</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Reorder factor levels for &#39;Manufacturer&#39; in the cereal data </span>
<span class="co"># by the mean amount of sodium.</span>

<span class="co"># Read data, show default (alphabetical) levels:</span>
<span class="kw">data</span>(cereals)
<span class="kw">levels</span>(cereals<span class="op">$</span>Manufacturer)</code></pre>
<pre><code>## [1] &quot;A&quot; &quot;G&quot; &quot;K&quot; &quot;N&quot; &quot;P&quot; &quot;Q&quot; &quot;R&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now reorder:</span>
cereals &lt;-<span class="st"> </span><span class="kw">mutate</span>(cereals, 
                 <span class="dt">Manufacturer =</span> <span class="kw">reorder</span>(Manufacturer, sodium, 
                                        median, <span class="dt">na.rm=</span><span class="ot">TRUE</span>))

<span class="co"># And inspect the new levels</span>
<span class="kw">levels</span>(cereals<span class="op">$</span>Manufacturer)</code></pre>
<pre><code>## [1] &quot;A&quot; &quot;N&quot; &quot;Q&quot; &quot;P&quot; &quot;K&quot; &quot;G&quot; &quot;R&quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Tables are now printed in order:</span>
<span class="kw">with</span>(cereals, <span class="kw">tapply</span>(sodium, Manufacturer, median))</code></pre>
<pre><code>##     A     N     Q     P     K     G     R 
##   0.0   7.5  75.0 160.0 170.0 200.0 200.0</code></pre>
<p>This trick comes in handy when making barplots; it is customary to plot them in ascending order if there is no specific order to the factor levels, as in this example.</p>
<p>The following code produces Fig. <a href="summarize.html#fig:coweetabar">3.5</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Here we read the data, add a reordered factor variable,</span>
<span class="co"># and continue with making the summary table used in the plot.</span>
<span class="kw">data</span>(coweeta)

coweeta_table &lt;-<span class="st"> </span>coweeta <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">species =</span> <span class="kw">reorder</span>(species, height, mean, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(species) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw">summarize</span>(<span class="dt">height_mean =</span> <span class="kw">mean</span>(height, <span class="dt">na.rm=</span><span class="ot">TRUE</span>),
            <span class="dt">height_sd =</span> <span class="kw">sd</span>(height, <span class="dt">na.rm=</span><span class="ot">TRUE</span>))

<span class="kw">ggplot</span>(coweeta_table, <span class="kw">aes</span>(<span class="dt">x =</span> species, <span class="dt">y =</span> height_mean)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>, <span class="dt">fill=</span><span class="st">&quot;red&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> height_mean <span class="op">-</span><span class="st"> </span>height_sd,
                    <span class="dt">ymax =</span> height_mean <span class="op">+</span><span class="st"> </span>height_sd), <span class="dt">width=</span><span class="fl">0.2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Height (m)&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;Species&quot;</span>)</code></pre>
<div class="figure"><span id="fig:coweetabar"></span>
<img src="02-dataskills_files/figure-html/coweetabar-1.pdf" alt="An ordered barplot for the coweeta tree data (error bars are 1 SD)." width="672" />
<p class="caption">
Figure 3.5: An ordered barplot for the coweeta tree data (error bars are 1 SD).
</p>
</div>
<p>The above example uses the more modern approach with <code>ggplot2</code> and <code>dplyr</code>, but we can get practically the same result with <code>doBy</code> and <code>gplots</code> - below is the code for comparison (output not shown).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(doBy)
coweeta<span class="op">$</span>species &lt;-<span class="st"> </span><span class="kw">with</span>(coweeta, <span class="kw">reorder</span>(species, height, mean, <span class="dt">na.rm=</span><span class="ot">TRUE</span>))
coweeta_agg &lt;-<span class="st"> </span><span class="kw">summaryBy</span>(height <span class="op">~</span><span class="st"> </span>species, <span class="dt">data=</span>coweeta, <span class="dt">FUN=</span><span class="kw">c</span>(mean,sd))

<span class="co"># For barplot2, which adds options for error bars</span>
<span class="kw">library</span>(gplots)

<span class="co"># This par setting makes the x-axis labels vertical, so they don&#39;t overlap.</span>
<span class="kw">par</span>(<span class="dt">las=</span><span class="dv">2</span>)
<span class="kw">with</span>(coweeta_agg, <span class="kw">barplot2</span>(height.mean, <span class="dt">names.arg=</span>species,
                           <span class="dt">space=</span><span class="fl">0.3</span>, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>,<span class="dt">plot.grid=</span><span class="ot">TRUE</span>,
                           <span class="dt">ylab=</span><span class="st">&quot;Height (m)&quot;</span>,
                           <span class="dt">plot.ci=</span><span class="ot">TRUE</span>,
                           <span class="dt">ci.l=</span>height.mean <span class="op">-</span><span class="st"> </span>height.sd,
                           <span class="dt">ci.u=</span>height.mean <span class="op">+</span><span class="st"> </span>height.sd))</code></pre>

<div class="rmdtry">
The above example orders the factor levels by increasing median sodium levels.
Try reversing the factor levels, using the following code after <code>reorder</code>.
<code>coweeta$species &lt;- factor(coweeta$species, levels=rev(levels(coweeta$species)))</code>
Here we used <code>rev</code> to reverse the levels.
</div>

</div>
</div>
<div id="combining-dataframes" class="section level2">
<h2><span class="header-section-number">3.9</span> Combining dataframes</h2>
<div id="merge" class="section level3">
<h3><span class="header-section-number">3.9.1</span> Merging dataframes</h3>
<p>If we have the following dataset called <code>plantdat</code>,</p>
<p><img src="screenshots/exampledata.png" width="33%" /></p>
<p>and we have another dataset, that includes the same <code>PlantID</code> variable (but is not necessarily ordered, nor does it have to include values for every plant):</p>
<p><img src="screenshots/leafnitrogendata.png" width="33%" /></p>
<p>and execute the command</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">merge</span>(plantdat, leafnitrogendata, <span class="dt">by=</span><span class="st">&quot;PlantID&quot;</span>)</code></pre>
<p>we get the result</p>
<p><img src="screenshots/mergeresult.png" width="33%" /></p>
<p>Note the missing value (<code>NA</code>) for the plant for which no leaf nitrogen data was available.</p>
<p>In many problems, you do not have a single dataset that contains all the measurements you are interested in – unlike most of the example datasets in this tutorial. Suppose you have two datasets that you would like to combine, or <code>merge</code>. This is straightforward in R, but there are some pitfalls.</p>
<p>Let’s start with a common situation when you need to combine two datasets that have a different number of rows.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Two dataframes</span>
data1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">unit=</span><span class="kw">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;x&quot;</span>,<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;z&quot;</span>,<span class="st">&quot;z&quot;</span>),<span class="dt">Time=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>))
data2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">unit=</span><span class="kw">c</span>(<span class="st">&quot;y&quot;</span>,<span class="st">&quot;z&quot;</span>,<span class="st">&quot;x&quot;</span>), <span class="dt">height=</span><span class="kw">c</span>(<span class="fl">3.4</span>,<span class="fl">5.6</span>,<span class="fl">1.2</span>))

<span class="co"># Look at the dataframes</span>
data1</code></pre>
<pre><code>##   unit Time
## 1    x    1
## 2    x    2
## 3    x    3
## 4    y    1
## 5    z    1
## 6    z    2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">data2</code></pre>
<pre><code>##   unit height
## 1    y    3.4
## 2    z    5.6
## 3    x    1.2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Merge dataframes:</span>
combdata &lt;-<span class="st"> </span><span class="kw">merge</span>(data1, data2, <span class="dt">by=</span><span class="st">&quot;unit&quot;</span>)

<span class="co"># Combined data</span>
combdata</code></pre>
<pre><code>##   unit Time height
## 1    x    1    1.2
## 2    x    2    1.2
## 3    x    3    1.2
## 4    y    1    3.4
## 5    z    1    5.6
## 6    z    2    5.6</code></pre>
<p>Sometimes, the variable you are merging with has a different name in either dataframe. In that case, you can either rename the variable before merging, or use the following option:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">merge</span>(data1, data2, <span class="dt">by.x=</span><span class="st">&quot;unit&quot;</span>, <span class="dt">by.y=</span><span class="st">&quot;item&quot;</span>)</code></pre>
<p>Where <code>data1</code> has a variable called ‘unit’, and <code>data2</code> has a variable called ‘item’.</p>
<p>Other times you need to merge two dataframes with multiple key variables. Consider this example, where two dataframes have measurements on the same units at some of the the same times, but on different variables:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Two dataframes</span>
data1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">unit=</span><span class="kw">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;x&quot;</span>,<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;z&quot;</span>,<span class="st">&quot;z&quot;</span>,<span class="st">&quot;z&quot;</span>),
<span class="dt">Time=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>),
<span class="dt">Weight=</span><span class="kw">c</span>(<span class="fl">3.1</span>,<span class="fl">5.2</span>,<span class="fl">6.9</span>,<span class="fl">2.2</span>,<span class="fl">5.1</span>,<span class="fl">7.5</span>,<span class="fl">3.5</span>,<span class="fl">6.1</span>,<span class="fl">8.0</span>))
data2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">unit=</span><span class="kw">c</span>(<span class="st">&quot;x&quot;</span>,<span class="st">&quot;x&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;y&quot;</span>,<span class="st">&quot;z&quot;</span>,<span class="st">&quot;z&quot;</span>),
<span class="dt">Time=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>),
<span class="dt">Height=</span><span class="kw">c</span>(<span class="fl">12.1</span>,<span class="fl">24.4</span>,<span class="fl">18.0</span>,<span class="fl">30.8</span>,<span class="fl">10.4</span>,<span class="fl">32.9</span>))

<span class="co"># Look at the dataframes</span>
data1</code></pre>
<pre><code>##   unit Time Weight
## 1    x    1    3.1
## 2    x    2    5.2
## 3    x    3    6.9
## 4    y    1    2.2
## 5    y    2    5.1
## 6    y    3    7.5
## 7    z    1    3.5
## 8    z    2    6.1
## 9    z    3    8.0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">data2</code></pre>
<pre><code>##   unit Time Height
## 1    x    1   12.1
## 2    x    2   24.4
## 3    y    2   18.0
## 4    y    3   30.8
## 5    z    1   10.4
## 6    z    3   32.9</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Merge dataframes:</span>
combdata &lt;-<span class="st"> </span><span class="kw">merge</span>(data1, data2, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;unit&quot;</span>,<span class="st">&quot;Time&quot;</span>))

<span class="co"># By default, only those times appear in the dataset that have measurements</span>
<span class="co"># for both Weight (data1) and Height (data2)</span>
combdata</code></pre>
<pre><code>##   unit Time Weight Height
## 1    x    1    3.1   12.1
## 2    x    2    5.2   24.4
## 3    y    2    5.1   18.0
## 4    y    3    7.5   30.8
## 5    z    1    3.5   10.4
## 6    z    3    8.0   32.9</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># To include all data, use this command. This produces missing values for some times:</span>
<span class="kw">merge</span>(data1, data2, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;unit&quot;</span>,<span class="st">&quot;Time&quot;</span>), <span class="dt">all=</span><span class="ot">TRUE</span>)</code></pre>
<pre><code>##   unit Time Weight Height
## 1    x    1    3.1   12.1
## 2    x    2    5.2   24.4
## 3    x    3    6.9     NA
## 4    y    1    2.2     NA
## 5    y    2    5.1   18.0
## 6    y    3    7.5   30.8
## 7    z    1    3.5   10.4
## 8    z    2    6.1     NA
## 9    z    3    8.0   32.9</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Compare this result with &#39;combdata&#39; above!</span></code></pre>
</div>
<div id="using-join-from-dplyr" class="section level3">
<h3><span class="header-section-number">3.9.2</span> Using join from <code>dplyr</code></h3>
<p>We showed how to use the <code>merge</code> function above, which is provided by base R. For larger datasets, it is advisable to use the <code>join*</code> functions from <code>dplyr</code>.</p>
<p>Instead of specifying which rows to keep with arguments <code>all.x</code>, <code>all</code>, etc., <code>dplyr</code> provides several functions that should make some intuitive sense. The table below compares <code>merge</code> and <code>join*</code>.</p>
<table style="width:96%;">
<colgroup>
<col width="51%" />
<col width="44%" />
</colgroup>
<thead>
<tr class="header">
<th><code>merge()</code></th>
<th><code>dplyr::join*</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>merge(dat1, dat2, all = FALSE)</code></td>
<td><code>inner_join(dat1, dat2)</code></td>
</tr>
<tr class="even">
<td><code>merge(dat1, dat2, all.x = TRUE)</code></td>
<td><code>left_join(dat1, dat2)</code></td>
</tr>
<tr class="odd">
<td><code>merge(dat1, dat2, all.y = TRUE)</code></td>
<td><code>right_join(dat1, dat2)</code></td>
</tr>
<tr class="even">
<td><code>merge(dat1, dat2, all = TRUE)</code></td>
<td><code>full_join(dat1, dat2)</code></td>
</tr>
</tbody>
</table>
<p>One other function is provided that has no simple equivalent in base R, <code>anti_join</code>, which can be used to find all observations that have <em>no match</em> between the two datasets. This can be handy for error-checking.</p>
<p>Consider the cereal dataset, which gives measurements of all sorts of contents of cereals. Suppose the measurements for ‘protein’, ‘vitamins’ and ‘sugars’ were all produced by different laboratories, and each lab sent you a separate dataset. To make things worse, some measurements for sugars and vitamins are missing, because samples were lost in those labs.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read the three datasets given to you from the three different labs:</span>
<span class="kw">data</span>(cereal1)
<span class="kw">data</span>(cereal2)
<span class="kw">data</span>(cereal3)

<span class="co"># As always, look at the first few rows of each dataset.</span>
<span class="kw">head</span>(cereal1, <span class="dv">3</span>)</code></pre>
<pre><code>##      Cereal.name protein
## 1 Frosted_Flakes       1
## 2     Product_19       3
## 3  Count_Chocula       1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(cereal2, <span class="dv">3</span>)</code></pre>
<pre><code>##     cerealbrand vitamins
## 1    Product_19      100
## 2 Count_Chocula       25
## 3    Wheat_Chex       25</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(cereal3, <span class="dv">3</span>)</code></pre>
<pre><code>##             cerealname sugars
## 1       Frosted_Flakes     11
## 2           Product_19      3
## 3 Mueslix_Crispy_Blend     13</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The name of the variable that ties the datasets together, </span>
<span class="co"># the &#39;cereal name&#39; differs between the datasets, as do the number of rows.</span>
<span class="co"># We can use merge() three times, but the data are easiest to merge with dplyr:</span>
<span class="kw">library</span>(dplyr)

cereal_combined &lt;-<span class="st"> </span><span class="kw">full_join</span>(cereal1, cereal2, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;Cereal.name&quot;</span> =<span class="st"> &quot;cerealbrand&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">                   </span><span class="kw">full_join</span>(cereal3, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;Cereal.name&quot;</span> =<span class="st"> &quot;cerealname&quot;</span>))

cereal_combined</code></pre>
<pre><code>##                  Cereal.name protein vitamins sugars
## 1             Frosted_Flakes       1       NA     11
## 2                 Product_19       3      100      3
## 3              Count_Chocula       1       25     NA
## 4                 Wheat_Chex       3       25     NA
## 5                 Honey-comb       1       25     NA
## 6  Shredded_Wheat_spoon_size       3        0     NA
## 7       Mueslix_Crispy_Blend       3       25     13
## 8          Grape_Nuts_Flakes       3       25      5
## 9    Strawberry_Fruit_Wheats       2       NA      5
## 10                  Cheerios       6       25      1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Note that missing values (NA) have been inserted where some data were not available.</span></code></pre>
</div>
<div id="rbind" class="section level3">
<h3><span class="header-section-number">3.9.3</span> Row-binding dataframes</h3>
<p>If we have the following dataset called <code>plantdat</code>,</p>
<p><img src="screenshots/rbindinput.png" width="33%" /></p>
<p>and we have another dataset (<code>plantdatmore</code>), <em>with exactly the same columns</em> (including the names and order of the columns),</p>
<p><img src="screenshots/moredataforrbind.png" width="33%" /></p>
<p>and execute the command</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rbind</span>(plantdat, plantdatmore)</code></pre>
<p>we get the result</p>
<p><img src="screenshots/rbindresult.png" width="33%" /></p>
<p>Using <code>merge</code>, we were able to glue dataframes together side-by-side based on one or more ‘index’ variables. Sometimes you have multiple datasets that can be glued together top-to-bottom, for example when you have multiple very similar dataframes. We can use the <code>rbind</code> function, like so:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Some fake data</span>
mydata1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">var1=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">var2=</span><span class="dv">5</span><span class="op">:</span><span class="dv">7</span>) 
mydata2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">var1=</span><span class="dv">4</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">var2=</span><span class="dv">8</span><span class="op">:</span><span class="dv">10</span>) 

<span class="co"># The dataframes have the same column names, in the same order:</span>
mydata1</code></pre>
<pre><code>##   var1 var2
## 1    1    5
## 2    2    6
## 3    3    7</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mydata2</code></pre>
<pre><code>##   var1 var2
## 1    4    8
## 2    5    9
## 3    6   10</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># So we can use rbind to row-bind them together:</span>
<span class="kw">rbind</span>(mydata1, mydata2)</code></pre>
<pre><code>##   var1 var2
## 1    1    5
## 2    2    6
## 3    3    7
## 4    4    8
## 5    5    9
## 6    6   10</code></pre>
<p>Let’s look at the above <code>rbind</code> example again but with a modification where some observations are duplicated between dataframes. This might happen, for example, when working with files containing time-series data and where there is some overlap between the two datasets. The <code>union</code> function from the <code>dplyr</code> package only returns unique observations:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Some fake data</span>
mydata1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">var1=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">var2=</span><span class="dv">5</span><span class="op">:</span><span class="dv">7</span>) 
mydata2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">var1=</span><span class="dv">2</span><span class="op">:</span><span class="dv">4</span>, <span class="dt">var2=</span><span class="dv">6</span><span class="op">:</span><span class="dv">8</span>) 

<span class="co"># The dataframes have the same column names, in the same order:</span>
mydata1</code></pre>
<pre><code>##   var1 var2
## 1    1    5
## 2    2    6
## 3    3    7</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">mydata2</code></pre>
<pre><code>##   var1 var2
## 1    2    6
## 2    3    7
## 3    4    8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># &#39;rbind&#39; leads to duplicate observations, &#39;union&#39; removes these:</span>
dplyr<span class="op">::</span><span class="kw">union</span>(mydata1, mydata2)</code></pre>
<pre><code>##   var1 var2
## 1    1    5
## 2    2    6
## 3    3    7
## 4    4    8</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rbind</span>(mydata1, mydata2)</code></pre>
<pre><code>##   var1 var2
## 1    1    5
## 2    2    6
## 3    3    7
## 4    2    6
## 5    3    7
## 6    4    8</code></pre>
<p>Sometimes, you want to <code>rbind</code> dataframes together but the column names do not exactly match. One option is to first process the dataframes so that they do match (using subscripting). Or, just use the <code>bind_rows</code> function from <code>dplyr</code>. Look at this example where we have two dataframes that have only one column in common, but we want to keep all the columns (and fill with <code>NA</code> where necessary),</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Some fake data</span>
mydata1 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">index=</span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>,<span class="st">&quot;C&quot;</span>), <span class="dt">var1=</span><span class="dv">5</span><span class="op">:</span><span class="dv">7</span>) 
mydata2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">var1=</span><span class="dv">8</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">species=</span><span class="kw">c</span>(<span class="st">&quot;one&quot;</span>,<span class="st">&quot;two&quot;</span>,<span class="st">&quot;three&quot;</span>)) 

<span class="co"># smartbind the dataframes together</span>
dplyr<span class="op">::</span><span class="kw">bind_rows</span>(mydata1, mydata2)</code></pre>
<pre><code>##   index var1 species
## 1     A    5    &lt;NA&gt;
## 2     B    6    &lt;NA&gt;
## 3     C    7    &lt;NA&gt;
## 4  &lt;NA&gt;    8     one
## 5  &lt;NA&gt;    9     two
## 6  &lt;NA&gt;   10   three</code></pre>
<p><em>Note:</em> an equivalent function to bind dataframes side-by-side is <code>cbind</code>, which can be used instead of <code>merge</code> when no index variables are present. However, in this book, the use of <code>cbind</code> is discouraged for dataframes as it can lead to problems that are difficult to fix, and in all practical applications a merge is preferable.</p>
</div>
</div>
<div id="reshaping" class="section level2">
<h2><span class="header-section-number">3.10</span> Reshaping data</h2>
<div id="from-wide-to-long" class="section level3">
<h3><span class="header-section-number">3.10.1</span> From wide to long</h3>
<p>In the majority of analyses in R, we like to have our data in ‘long’ format (nowadays sometimes called the ‘tidy’ format), where the data for some kind of measurement are in one column, and we have one or more factor variables distinguishing groups like individual, date, treatment, and so on. It is however common encounter data in ‘wide format’, which can be converted to long format by reshaping appropriately.</p>
<p>The first example uses the dutch election data.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(dutchelection)
<span class="kw">head</span>(dutchelection,<span class="dv">3</span>)</code></pre>
<pre><code>##         Date  VVD PvdA  PVV CDA   SP D66  GL  CU SGP PvdD FiftyPlus
## 1 2012-03-22 22.1 16.8 13.9 9.4 16.8 7.7 4.5 3.3 1.5  2.4       1.1
## 2 2012-04-05 23.6 17.1 13.3 8.8 16.3 8.7 4.1 3.2 1.4  2.0       0.8
## 3 2012-04-19 24.0 17.3 12.0 8.2 17.0 8.8 3.5 3.3 1.6  3.1       0.8</code></pre>
<p>The data include percentage votes for 11 Dutch political parties in a 2012 election, and somewhat intuitively the parties have been ordered as columns (so that each row adds up to ca. 100%, ignoring some tiny parties). For purposes of analysis, we would like to reshape this dataset to long format, so that we have just columns ‘Date’, ‘Party’, and ‘Poll’. Right now ‘Party’ is in the column names, and ‘Poll’ represents the polling numbers; the actual data in the cells.</p>
<p>As is often the case, there are many ways to solve this. For most basic reshaping tasks we recommend the <code>tidyr</code> package, however some other methods may be needed for more complex tasks, as we find in further examples below.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)
<span class="co"># The new dataframe will have a column &#39;Party&#39; with current columns,</span>
<span class="co"># *except* Date (hence the -Date),</span>
<span class="co"># and values will be stored in &#39;Poll&#39;</span>
elect_long &lt;-<span class="st"> </span><span class="kw">gather</span>(dutchelection, Party, Poll, <span class="op">-</span>Date)
<span class="kw">head</span>(elect_long,<span class="dv">3</span>)</code></pre>
<pre><code>##         Date Party Poll
## 1 2012-03-22   VVD 22.1
## 2 2012-04-05   VVD 23.6
## 3 2012-04-19   VVD 24.0</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Identical results can be had with melt() from reshape2,</span>
<span class="co"># a function which otherwise includes more options.</span>
<span class="co"># See `?melt.data.frame` for more options (not `?melt`, </span>
<span class="co"># which is the generic function).</span>
<span class="kw">library</span>(reshape2)
elect_long &lt;-<span class="st"> </span><span class="kw">melt</span>(dutchelection, <span class="dt">variable.name=</span><span class="st">&quot;Party&quot;</span>, <span class="dt">value.name=</span><span class="st">&quot;Poll&quot;</span>, <span class="dt">id.vars=</span><span class="st">&quot;Date&quot;</span>)</code></pre>
<p>The advantage of <code>melt</code> is that we can include more than one ID variables, like in the following example. This example also shows the common need for some text processing after reshaping.</p>
<p>In this simple dataset, length of feet and hands was measured on two persons on three consecutive days. We want to reshape it to end up with columns ‘Day’, ‘Person’, ‘Length’ and ‘BodyPart’ (feet or hands).</p>
<pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Day=</span><span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">each=</span><span class="dv">2</span>), <span class="dt">Person=</span><span class="kw">rep</span>(letters[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="dv">3</span>), 
                  <span class="dt">Length.feet =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="dv">3</span>),
                  <span class="dt">Length.hands=</span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>),<span class="dv">3</span>))
dat</code></pre>
<pre><code>##   Day Person Length.feet Length.hands
## 1   1      a           2            3
## 2   1      b           3            4
## 3   2      a           2            3
## 4   2      b           3            4
## 5   3      a           2            3
## 6   3      b           3            4</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Now reshape to long format, using melt.data.frame</span>
dat_long &lt;-<span class="st"> </span><span class="kw">melt</span>(dat, <span class="dt">id.vars=</span><span class="kw">c</span>(<span class="st">&quot;Day&quot;</span>,<span class="st">&quot;Person&quot;</span>), <span class="dt">value.name=</span><span class="st">&quot;Length&quot;</span>, 
    <span class="dt">variable.name=</span><span class="st">&quot;BodyPart&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">BodyPart =</span> <span class="kw">gsub</span>(<span class="st">&quot;Length.&quot;</span>, <span class="st">&quot;&quot;</span>, BodyPart))

dat_long</code></pre>
<pre><code>##    Day Person BodyPart Length
## 1    1      a     feet      2
## 2    1      b     feet      3
## 3    2      a     feet      2
## 4    2      b     feet      3
## 5    3      a     feet      2
## 6    3      b     feet      3
## 7    1      a    hands      3
## 8    1      b    hands      4
## 9    2      a    hands      3
## 10   2      b    hands      4
## 11   3      a    hands      3
## 12   3      b    hands      4</code></pre>
</div>
<div id="from-long-to-wide" class="section level3">
<h3><span class="header-section-number">3.10.2</span> From long to wide</h3>
<p>Occasionally we like to use wide format, where groups of data are placed next to each other instead of on top of each other. For the first example consider this simple dataset with a set of questions asked to two persons,</p>
<pre class="sourceCode r"><code class="sourceCode r">survey &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">text=</span><span class="st">&quot;user question    answer</span>
<span class="st">a   question_1  hi</span>
<span class="st">a   question_2  hey</span>
<span class="st">a   question_3  oh</span>
<span class="st">a   question_4  no</span>
<span class="st">a   question_5  yes</span>
<span class="st">a   question_6  obv</span>
<span class="st">b   question_1  cool</span>
<span class="st">b   question_2  good</span>
<span class="st">b   question_3  yes</span>
<span class="st">b   question_4  sweet</span>
<span class="st">b   question_5  wow</span>
<span class="st">b   question_6  no&quot;</span>, <span class="dt">header=</span><span class="ot">TRUE</span>)

survey</code></pre>
<pre><code>##    user   question answer
## 1     a question_1     hi
## 2     a question_2    hey
## 3     a question_3     oh
## 4     a question_4     no
## 5     a question_5    yes
## 6     a question_6    obv
## 7     b question_1   cool
## 8     b question_2   good
## 9     b question_3    yes
## 10    b question_4  sweet
## 11    b question_5    wow
## 12    b question_6     no</code></pre>
<p>In this case we actually want to have all data for each ‘user’ in a single row, thus creating columns ‘question_1’, ‘question_2’ and so on. The first solution uses <code>spread</code> from <code>tidyr</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)
<span class="kw">spread</span>(survey, question, answer)</code></pre>
<pre><code>##   user question_1 question_2 question_3 question_4 question_5 question_6
## 1    a         hi        hey         oh         no        yes        obv
## 2    b       cool       good        yes      sweet        wow         no</code></pre>
<p>The second solution uses <code>dcast</code> from <code>reshape2</code>. I show this solution because unlike <code>spread</code>, <code>dcast</code> can be used for more complicated reshaping problems.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(reshape2)
<span class="kw">dcast</span>(survey, user <span class="op">~</span><span class="st"> </span>question, <span class="dt">value.var=</span><span class="st">&quot;answer&quot;</span>)</code></pre>
<pre><code>##   user question_1 question_2 question_3 question_4 question_5 question_6
## 1    a         hi        hey         oh         no        yes        obv
## 2    b       cool       good        yes      sweet        wow         no</code></pre>
<p>Here, the formula indicates ‘user goes in rows, question in columns’, and <code>value.var</code> is the name of the variable used to populate the cells.</p>
<p>For the second, more complex, example we use a small version of the <code>eucface_gasexchange</code> dataset, which includes measurements of photosynthesis (<code>Photo</code>) on two experimental plots (<code>Plot</code>) on three Dates (<code>Date</code>), under two experimental treatments (<code>treatment</code>). Clearly we have multiple levels of nesting of our data, and each of these nesting levels is represented by a different variable.</p>
<pre class="sourceCode r"><code class="sourceCode r">gas &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="dt">text=</span><span class="st">&quot;Date    Plot    treatment   Photo</span>
<span class="st">A   1   Amb 14.4</span>
<span class="st">A   1   Ele 16.3</span>
<span class="st">A   2   Amb 17.8</span>
<span class="st">A   2   Ele 13.3</span>
<span class="st">B   1   Amb 16.4</span>
<span class="st">B   1   Ele 19</span>
<span class="st">B   2   Amb 15</span>
<span class="st">B   2   Ele 10.8</span>
<span class="st">C   1   Amb 17.5</span>
<span class="st">C   1   Ele 19.8</span>
<span class="st">C   2   Amb 13.5</span>
<span class="st">C   2   Ele 12.1</span>
<span class="st">&quot;</span>, <span class="dt">header=</span><span class="ot">TRUE</span>)</code></pre>
<p>Now we have two variables that describe which measurements ‘belong together’ (experimental plot, and treatment). We can no longer use <code>spread</code> (which uses just one of those variables), but <code>dcast</code> does work nicely with multiple groupings:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dcast</span>(gas, Date <span class="op">+</span><span class="st"> </span>Plot <span class="op">~</span><span class="st"> </span>treatment, <span class="dt">value.var=</span><span class="st">&quot;Photo&quot;</span>)</code></pre>
<pre><code>##   Date Plot  Amb  Ele
## 1    A    1 14.4 16.3
## 2    A    2 17.8 13.3
## 3    B    1 16.4 19.0
## 4    B    2 15.0 10.8
## 5    C    1 17.5 19.8
## 6    C    2 13.5 12.1</code></pre>
<p>We have another possibility here, to instead place the values for the individual plots and treatments next to each other. Note we now move <code>Plot</code> to the right-hand side of the formula in <code>dcast</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dcast</span>(gas, Date <span class="op">~</span><span class="st"> </span>Plot <span class="op">+</span><span class="st"> </span>treatment, <span class="dt">value.var=</span><span class="st">&quot;Photo&quot;</span>)</code></pre>
<pre><code>##   Date 1_Amb 1_Ele 2_Amb 2_Ele
## 1    A  14.4  16.3  17.8  13.3
## 2    B  16.4  19.0  15.0  10.8
## 3    C  17.5  19.8  13.5  12.1</code></pre>
</div>
</div>
<div id="more-complex-dplyr-examples" class="section level2">
<h2><span class="header-section-number">3.11</span> More complex <code>dplyr</code> examples</h2>
<p>In this chapter, we have learned many new tools to work with data - filtering, summarizing, reshaping, and so on. One advantage of the <code>dplyr</code> package over functions in base R is that the various operations can be efficiently combined with the <code>%&gt;%</code> operator, combining all your data converting and shaping steps into one.</p>
<p>This will become clear with some examples.</p>
<div id="tree-growth-data-filter-and-multiple-groupings" class="section level3">
<h3><span class="header-section-number">3.11.1</span> Tree growth data: filter and multiple groupings</h3>
<p>The first example uses the <code>hfeifbytree</code> data from the <code>lgrdata</code> package. This dataset contains measurements of height and stem diameter on nearly 1200 Eucalyptus trees in Sydney, repeated 17 times. The trees grow in plots subjected to different treatments (control, fertilization, irrigation, or both).</p>
<p>On some of the dates, all trees were measured, while on other dates a small subsample was taken (ca. 10% of all trees). We want to make a plot of average tree height by treatment over time, but use only the dates were all trees were measured. The following code makes Fig. <a href="summarize.html#fig:hfeifmeanplot">3.6</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(hfeifbytree)

<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)   
<span class="kw">library</span>(ggthemes)

hfeif_meanh &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(hfeifbytree, <span class="dt">Date =</span> <span class="kw">as.Date</span>(Date)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Convert to proper Date</span>
<span class="st">  </span><span class="kw">group_by</span>(Date) <span class="op">%&gt;%</span><span class="st">              </span><span class="co"># Set up the grouping variable</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">n</span>() <span class="op">&gt;</span><span class="st"> </span><span class="dv">500</span>) <span class="op">%&gt;%</span><span class="st">           </span><span class="co"># Keep groups with more than 500 observations</span>
<span class="st">  </span><span class="kw">group_by</span>(Date, treat) <span class="op">%&gt;%</span><span class="st">       </span><span class="co"># New grouping; to get average by Date and treatment</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">height =</span> <span class="kw">mean</span>(height, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Average height, discard NA.</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">treatment =</span> treat)       <span class="co"># rename a variable</span>
  
<span class="co"># It is possible to make the plot inside the data pipeline, but</span>
<span class="co"># we recommend separating them!</span>
<span class="kw">ggplot</span>(hfeif_meanh, <span class="kw">aes</span>(<span class="dt">x =</span> Date, <span class="dt">y =</span> height, <span class="dt">col =</span> treatment)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_colour_tableau</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">ylim</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">20</span>))</code></pre>
<div class="figure"><span id="fig:hfeifmeanplot"></span>
<img src="02-dataskills_files/figure-html/hfeifmeanplot-1.pdf" alt="Average tree height by treatment over time, for the hfeifbytree data" width="672" />
<p class="caption">
Figure 3.6: Average tree height by treatment over time, for the hfeifbytree data
</p>
</div>
</div>
<div id="crude-oil-production-find-top-exporters" class="section level3">
<h3><span class="header-section-number">3.11.2</span> Crude oil production: find top exporters</h3>
<p>In the second example we will use the <code>oil</code> data, a dataset with annual crude oil production for the top 8 oil-producing countries since 1971. We want to find the top three countries for the period 1980-1985, sort them, and replace the country abbreviations with country names.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(oil)

<span class="co"># First we make a dataframe with the abbreviations.</span>
<span class="co"># Very handy here is tribble from tibble; making it easier to write</span>
<span class="co"># small dataframes directly into your script.</span>
<span class="kw">library</span>(tibble)
abb_key &lt;-<span class="st"> </span><span class="kw">tribble</span>(<span class="op">~</span>country, <span class="op">~</span>country_full,
                      <span class="st">&quot;MEX&quot;</span>,    <span class="st">&quot;Mexico&quot;</span>,
                      <span class="st">&quot;USA&quot;</span>,    <span class="st">&quot;USA&quot;</span>,
                      <span class="st">&quot;CHN&quot;</span>,    <span class="st">&quot;China&quot;</span>,
                      <span class="st">&quot;IRN&quot;</span>,    <span class="st">&quot;Iran&quot;</span>,
                      <span class="st">&quot;SAU&quot;</span>,    <span class="st">&quot;Saudi-Arabia&quot;</span>,
                      <span class="st">&quot;IRQ&quot;</span>,    <span class="st">&quot;Iraq&quot;</span>,
                      <span class="st">&quot;KWT&quot;</span>,    <span class="st">&quot;Kuwait&quot;</span>,
                      <span class="st">&quot;VEN&quot;</span>,    <span class="st">&quot;Venezuela&quot;</span>)

<span class="co"># To avoid a warning, we first convert country to character</span>
<span class="co"># (not strictly necessary)</span>
oil_top &lt;-
<span class="st">  </span><span class="kw">mutate</span>(oil, 
         <span class="dt">country =</span> <span class="kw">as.character</span>(country),
         <span class="dt">production_M =</span> production <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Convert to million tonnes.</span>
<span class="st">  </span><span class="kw">full_join</span>(abb_key, <span class="dt">by=</span><span class="st">&quot;country&quot;</span>) <span class="op">%&gt;%</span><span class="st">          </span><span class="co"># Add full country name</span>
<span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="dv">1980</span><span class="op">:</span><span class="dv">1985</span>) <span class="op">%&gt;%</span><span class="st">               </span><span class="co"># Subset for years between 1980-1985</span>
<span class="st">  </span><span class="kw">group_by</span>(country_full) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarize</span>(<span class="dt">production_M =</span> <span class="kw">mean</span>(production_M)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">desc</span>(production_M)) <span class="op">%&gt;%</span><span class="st">               </span><span class="co"># Sort by production; in descending order</span>
<span class="st">  </span>as.data.frame <span class="op">%&gt;%</span><span class="st">                             </span><span class="co"># To be consistent, output a dataframe</span>
<span class="st">  </span><span class="kw">head</span>(., <span class="dv">3</span>)                                    <span class="co"># Only show the top 32</span>

<span class="co"># Finally make a table that looks nice in an rmarkdown document</span>
<span class="kw">library</span>(pander)
oil_top <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pander</span>(., 
                   <span class="dt">caption =</span> <span class="st">&quot;Top three oil producing countries, 1980-1985.&quot;</span>,
                   <span class="dt">col.names =</span> <span class="kw">c</span>(<span class="st">&quot;Country&quot;</span>, <span class="st">&quot;Annual production (MTOE)&quot;</span>))</code></pre>
<table style="width:58%;">
<caption>Top three oil producing countries, 1980-1985.</caption>
<colgroup>
<col width="20%" />
<col width="37%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">Country</th>
<th align="center">Annual production (MTOE)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">USA</td>
<td align="center">443.5</td>
</tr>
<tr class="even">
<td align="center">Saudi-Arabia</td>
<td align="center">335.1</td>
</tr>
<tr class="odd">
<td align="center">Mexico</td>
<td align="center">138.8</td>
</tr>
</tbody>
</table>
</div>
<div id="weight-loss-data-make-an-irregular-timeseries-regular" class="section level3">
<h3><span class="header-section-number">3.11.3</span> Weight loss data: make an irregular timeseries regular</h3>
<p>In this example we will use the <code>weightloss</code> data, again from the <code>lgrdata</code> package. A person recorded his weight on irregular intervals (1-3 days), to check if his diet was having the desired effect. Because the dataset is irregular, it is not easy to calculate daily weight loss for the entire dataset. We can use a combination of <code>dplyr</code>, <code>zoo</code> and <code>padr</code> to clean up this dataset.</p>
<p>The <code>pad</code> function is quite powerful: it takes a dataframe, figures the time-indexing variable (in our case, Date), and stretches the dataset to include all Dates along the dataset, filling NA where no data were available.</p>
<p>The <code>zoo</code> package contains many useful functions for timeseries data. Here we use <code>na.approx</code> to linearly interpolate missing values. We also make a plot of the weight loss data, clarifying which data were interpolated. The following code make Fig. <a href="#weightlossinterp"><strong>??</strong></a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(zoo)
<span class="kw">library</span>(padr)

<span class="kw">data</span>(weightloss)

weightloss2 &lt;-<span class="st"> </span><span class="kw">mutate</span>(weightloss, 
                      <span class="dt">Date =</span> <span class="kw">dmy</span>(Date),                <span class="co"># proper Date class</span>
                      <span class="dt">Weight =</span> Weight <span class="op">*</span><span class="st"> </span><span class="fl">0.4536</span>) <span class="op">%&gt;%</span><span class="st">    </span><span class="co"># convert to kg</span>
<span class="st">               </span><span class="kw">pad</span>(<span class="dt">interval =</span><span class="st">&quot;day&quot;</span>) <span class="op">%&gt;%</span><span class="st">                </span><span class="co"># timeseries is now regular</span>
<span class="st">               </span><span class="kw">mutate</span>(<span class="dt">measured =</span> <span class="op">!</span><span class="kw">is.na</span>(Weight),  <span class="co"># FALSE when the value was interpolated</span>
                      <span class="dt">Weight =</span> <span class="kw">na.approx</span>(Weight))      <span class="co"># linear interpolation (zoo)</span>
  
<span class="kw">ggplot</span>(weightloss2, <span class="kw">aes</span>(<span class="dt">x =</span> Date, <span class="dt">y =</span> Weight)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">colour =</span> <span class="kw">ifelse</span>(weightloss2<span class="op">$</span>measured, <span class="st">&quot;darkgrey&quot;</span>, <span class="st">&quot;red2&quot;</span>))</code></pre>
<div class="figure"><span id="fig:weightlossinterp"></span>
<img src="02-dataskills_files/figure-html/weightlossinterp-1.pdf" alt="The weightloss data, with linearly interpolated missing values (red)." width="672" />
<p class="caption">
Figure 3.7: The weightloss data, with linearly interpolated missing values (red).
</p>
</div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="reporting.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["twitter", "linkedin"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["prcr.pdf"],
"toc": {
"collapse": "subsection"
},
"favicon": "favicon.ico",
"githubrepo": "RemkoDuursma/prcr",
"description": "A Learning Guide to R: : data, analytical, and programming skills"
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
